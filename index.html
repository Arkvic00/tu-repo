<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dosis Perronas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');
        
        // Global variables for Firebase
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs };
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* bg-slate-950 */
        }
        .prose p { margin-bottom: 0.75em; }
        .prose strong { font-weight: bold; color: #93c5fd; } /* text-blue-300 */
        .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #60a5fa; } /* text-blue-400 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 101;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.25;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .ai-response-container {
            white-space: pre-wrap; /* Allows text to wrap and respects line breaks */
            font-family: monospace;
            background-color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            color: #e2e8f0;
            margin-top: 1rem;
            border: 1px solid #4a5568;
        }
        /* Custom styles for PDF recipe preview */
        .recipe-preview {
            background-color: #f8fafc; /* Slate-50 */
            border: 1px solid #e2e8f0; /* Slate-200 */
            color: #1e293b; /* Slate-800 */
            padding: 2rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
        }
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }
        .vet-info h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .vet-info p {
            font-size: 0.875rem;
        }
        .patient-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .patient-info-item {
            border-bottom: 1px solid #94a3b8; /* Slate-400 */
            padding-bottom: 0.25rem;
        }
        .patient-info-item label {
            font-weight: bold;
            font-size: 1rem;
        }
        .prescription-section h2 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .medication-item {
            border-bottom: 1px solid #e2e8f0; /* Slate-200 */
            padding: 1rem 0;
        }
        .medication-item:last-child {
            border-bottom: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-950">
    <div id="root"></div>

    <script type="text/babel">
        // --- SVG Icons ---
        const ClipboardList = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></svg> );
        const X = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="6" y1="6" y2="18" /><line x1="6" x2="18" y1="6" y2="18" /></svg> );
        const PlusCircle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="16" /><line x1="8" x2="16" y1="12" y2="12" /></svg> );
        const RotateCw = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 2v6h-6" /><path d="M3 12a9 9 0 0 1 15-6.7L21 8" /><path d="M3 22v-6h6" /><path d="M21 12a9 9 0 0 1-15 6.7L3 16" /></svg> );
        const Siren = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 12c-1.933 0-3.5-1.567-3.5-3.5S10.067 5 12 5s3.5 1.567 3.5 3.5"/><path d="M12 12v6"/><path d="M12 12H6m6 0h6"/><path d="M18 12c0 3.314-2.686 6-6 6s-6-2.686-6-6"/><path d="M6 12c0-3.314 2.686-6 6-6s6 2.686 6 6"/><path d="M12 5V2"/><path d="M5 12H2m20 0h-3"/></svg> );
        const Calculator = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><line x1="16" x2="12" y1="14" y2="14" /><line x1="12" y1="14" x2="12" y2="18" /><line x1="8" y1="14" x2="8" y2="18" /></svg> );
        const AlertTriangle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg> );
        const Square = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2"/></svg> );
        const ChevronDown = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg> );
        const Droplet = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C5 11.1 4 13 4 15a7 7 0 0 0 7 7z"/></svg> );
        const Beaker = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-16V3"/><path d="M6 14h12"/></svg> );
        const Menu = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" y2="6" x2="20" y2="6"/><line x1="4" y2="18" x2="20" y2="18"/></svg> );
        const MoreVertical = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg> );
        const HelpCircle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> );
        const FileDown = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg> );
        const Star = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg> );
        const BookOpen = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> );
        const HeartPulse = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19.5 12.5c0-1.5-1.1-2.8-2.5-3-1.4-.2-2.8.4-3.5 1.5-1.1 1.6-3.2 1.6-4.2 0-1.1-1.6-3.2-1.6-4.2 0C3.7 12.4 3 14.2 3 16c0 2.8 2.2 5 5 5 1.2 0 2.3-.4 3.1-1.2.8.8 1.9 1.2 3.1 1.2 2.8 0 5-2.2 5-5 0-1.1-.4-2.2-1-3-.6-.8-1.5-1.2-2.5-1.2z"/><path d="M12.5 10.5 15 13l2-1.5-2-1.5-2.5 2.5z"/></svg> );
        const FlaskConical = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 2v7.31"/><path d="M14 9.31V2"/><path d="M8.5 2h7"/><path d="M14 9.31 16.5 4"/><path d="M10 9.31 7.5 4"/><path d="M12 14v8"/><path d="M8.7 14H5.1c-1.7 0-3.1 1.4-3.1 3.1 0 1.3.8 2.5 2 2.9l1.2.4c.9.3 1.8.3 2.7 0l1.2-.4c1.2-.4 2-1.6 2-2.9.1-1.7-1.3-3.1-3-3.1h-3.7z"/></svg> );
        const Save = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg> );
        const Trash = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg> );
        const Slash = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> );
        const Lightbulb = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg> );
        const Zap = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> );
        const Shuffle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="16 16 21 16 21 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg> );
        const Users = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> );
        const VetIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-crosshair">
                <circle cx="12" cy="12" r="10"/>
                <line x1="22" x2="18" y1="12" y2="12"/>
                <line x1="6" x2="2" y1="12" y2="12"/>
                <line x1="12" x2="12" y1="6" y2="2"/>
                <line x1="12" x2="12" y1="22" y2="18"/>
            </svg>
        );

        // --- UNIFIED DATABASE ---
        const initialMedications = [
            {"name": "Acarbosa", "commercial_names": ["Glucobay®", "Precose®"], "concentration": {"Tabletas": "50 mg"}, "doses": {"Perros": [{"purpose": "Control glucémico adyuvante", "dose_range_min": 12.5, "dose_range_rec": 25, "dose_range_max": 100, "unit": "mg/perro", "route": "PO", "frequency": "c/8-12h con comida"}], "Gatos": [{"purpose": "Control glucémico adyuvante", "dose_range_min": 12.5, "dose_range_rec": 12.5, "dose_range_max": 25, "unit": "mg/gato", "route": "PO", "frequency": "c/12h con comida"}]}, "functions": ["Inhibidor de la alfa-glucosidasa; retrasa la digestión de carbohidratos para controlar la hiperglucemia postprandial."], "recommendations": ["Administrar con el primer bocado de comida. El efecto máximo puede tardar semanas."], "precautions": ["Puede causar flatulencia y diarrea. Usar con cautela en enfermedad gastrointestinal, renal o hepática."], "contraindications": ["Cetoacidosis diabética, enfermedad inflamatoria intestinal, obstrucción intestinal."], "interactions": {"summary": "Aumenta el riesgo de hipoglucemia con insulina; su efecto disminuye con adsorbentes intestinales.", "specifics": [{"drug": "Insulina", "effect": "Aumenta riesgo de hipoglucemia"}, {"drug": "Carbón activado", "effect": "Reduce la eficacia de la acarbosa"}]}, "substitutes": ["Glipizida", "Metformina"]},
            {"name": "Acarina", "commercial_names": ["Genérico"], "concentration": {"Presentación": "No documentado"}, "functions": ["No documentado"], "recommendations": ["No documentado"], "precautions": ["No documentado"], "contraindications": ["No documentado"], "interactions": {"summary": "No documentado", "specifics": []}, "substitutes": ["No documentado"]},
            {"name": "Aceite Mineral", "commercial_names": ["Kondremul®"], "concentration": {"Líquido": "100%"}, "doses": {"Perros": [{"purpose": "Laxante lubricante", "dose_range_min": 5, "dose_range_rec": 15, "dose_range_max": 30, "unit": "mL/perro", "route": "PO", "frequency": "Según se necesite"}], "Gatos": [{"purpose": "Laxante lubricante, bolas de pelo", "dose_range_min": 2, "dose_range_rec": 5, "dose_range_max": 10, "unit": "mL/gato", "route": "PO", "frequency": "Según se necesite"}], "Conejos": [{"purpose": "Laxante", "dose_range_min": 5, "dose_range_rec": 10, "dose_range_max": 15, "unit": "mL/conejo", "route": "PO", "frequency": "c/12-24h"}], "Hurones": [{"purpose": "Laxante", "dose_range_min": 5, "dose_range_rec": 10, "dose_range_max": 20, "unit": "mL/hurón", "route": "PO", "frequency": "c/12-24h"}], "Reptiles": [{"purpose": "Laxante para constipación", "dose_range_min": 1, "dose_range_rec": 1, "dose_range_max": 2, "unit": "mL/kg", "route": "PO", "frequency": "c/24-48h"}]}, "functions": ["Laxante emoliente/lubricante. Actúa recubriendo las heces para facilitar su paso."], "recommendations": ["Administrar con cuidado para evitar la aspiración. No es ideal para uso crónico."], "precautions": ["El principal riesgo es la neumonía por aspiración si se administra incorrectamente. El uso crónico puede interferir con la absorción de vitaminas liposolubles (A, D, E, K)."], "contraindications": ["Pacientes con riesgo de aspiración, vómitos o disfagia."], "interactions": {"summary": "Puede disminuir la absorción de fármacos liposolubles.", "specifics": []}, "substitutes": ["Docusato Sódico", "Lactulosa", "Psyllium"]},
            {"name": "Acemanano", "commercial_names": ["Acemannan Immunostimulant®", "CarraVet®"], "concentration": {"Polvo para reconstituir": "10 mg"}, "doses": {"Perros": [{"purpose": "Coadyuvante en fibrosarcoma", "dose_range_min": 1, "dose_range_rec": 1, "dose_range_max": 2, "unit": "mg/kg IP y 2 mg intralesional", "route": "IP, Intralesional", "frequency": "Semanalmente"}], "Gatos": [{"purpose": "Coadyuvante en fibrosarcoma", "dose_range_min": 1, "dose_range_rec": 1, "dose_range_max": 2, "unit": "mg/kg IP y 2 mg intralesional", "route": "IP, Intralesional", "frequency": "Semanalmente"}]}, "functions": ["Inmunoestimulante derivado del aloe vera que induce la liberación de citoquinas; usado como terapia adyuvante para fibrosarcomas."], "recommendations": ["Debe ser reconstituido y administrado por un veterinario. Su uso en infecciones virales es experimental."], "precautions": ["La inyección IV rápida puede causar reacciones anafilactoides. La inyección intralesional puede ser dolorosa."], "contraindications": ["Hipersensibilidad conocida al acemanano o aloe vera."], "interactions": {"summary": "No se han reportado interacciones significativas.", "specifics": []}, "substitutes": ["Interferón Omega Felino"], "uses": ["aumenta la capacidad de cicatrización y el tejido de granulación, incentiva la angiogénesis y la epitelización. revierte el defecto existente en los tejidos isquémicos.\nindicado para acelerar el proceso de cicatrización en cualquier \ntipo de herida.\nacemananoestimula la proliferación de fi  broblast"]},
            {"name": "Acepromazina Maleato", "commercial_names": ["Aceproject®", "Atravet®", "PromAce®"], "concentration": {"Solución Inyectable": "10 mg/mL", "Tabletas": "10 mg"}, "doses": {"Perros": [{"purpose": "Sedación/Tranquilización", "dose_range_min": 0.025, "dose_range_rec": 0.1, "dose_range_max": 0.2, "unit": "mg/kg", "route": "IV, IM, SC", "frequency": "Según se necesite (máx 3 mg total)"}, {"purpose": "Preanestesia", "dose_range_min": 0.05, "dose_range_rec": 0.1, "dose_range_max": 0.2, "unit": "mg/kg", "route": "IV, IM", "frequency": "Dosis única"}], "Gatos": [{"purpose": "Sedación/Tranquilización", "dose_range_min": 0.05, "dose_range_rec": 0.075, "dose_range_max": 0.1, "unit": "mg/kg", "route": "IV, IM, SC", "frequency": "Según se necesite (máx 1 mg total)"}], "Equinos": [{"purpose": "Sedación", "dose_range_min": 0.02, "dose_range_rec": 0.03, "dose_range_max": 0.05, "unit": "mg/kg", "route": "IV, IM", "frequency": "Según se necesite"}], "Bovinos": [{"purpose": "Sedación", "dose_range_min": 0.03, "dose_range_rec": 0.05, "dose_range_max": 0.1, "unit": "mg/kg", "route": "IM", "frequency": "Según se necesite"}], "Ovinos y Caprinos": [{"purpose": "Sedación", "dose_range_min": 0.05, "dose_range_rec": 0.075, "dose_range_max": 0.1, "unit": "mg/kg", "route": "IM", "frequency": "Según se necesite"}], "Hurones": [{"purpose": "Sedación", "dose_range_min": 0.2, "dose_range_rec": 0.35, "dose_range_max": 0.5, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}], "Conejos": [{"purpose": "Sedación", "dose_range_min": 0.1, "dose_range_rec": 0.5, "dose_range_max": 1, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}], "Ratones": [{"purpose": "Sedación", "dose_range_min": 2.5, "dose_range_rec": 3, "dose_range_max": 5, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}], "Ratas": [{"purpose": "Sedación", "dose_range_min": 2.5, "dose_range_rec": 3, "dose_range_max": 5, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}], "Hámsters": [{"purpose": "Sedación", "dose_range_min": 2.5, "dose_range_rec": 5, "dose_range_max": 10, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}], "Cobayas": [{"purpose": "Sedación", "dose_range_min": 2.5, "dose_range_rec": 5, "dose_range_max": 10, "unit": "mg/kg", "route": "IM, SC", "frequency": "Según se necesite"}]}, "functions": ["Neuroléptico fenotiazínico usado como tranquilizante y preanestésico. No tiene propiedades analgésicas."], "recommendations": ["Usar dosis menores en razas braquicefálicas, lebreles y con mutación MDR1. Administrar IV lentamente."], "precautions": ["Causa hipotensión. Puede disminuir el umbral convulsivo. Usar con extrema precaución en animales deshidratados, en shock o cardiópatas."], "contraindications": ["Historial de convulsiones, shock, intoxicación por estricnina. Usar con cautela en sementales por riesgo de priapismo. Sensibilidad racial: Bóxers (pueden experimentar síncope vasovagal severo), Lebreles (sedación prolongada), razas gigantes."], "interactions": {"summary": "Potencia el efecto de otros depresores del SNC. No usar epinefrina para tratar la hipotensión inducida.", "specifics": [{"drug": "Opioides, anestésicos", "effect": "Potencian la sedación y depresión respiratoria"}, {"drug": "Organofosforados", "effect": "Aumenta su toxicidad"}]}, "substitutes": ["Dexmedetomidina", "Diazepam", "Trazodona"]},
            {"name": "Acetaminofén (Paracetamol)", "commercial_names": ["Tempra®", "Tylenol®"], "concentration": {"Gotas Pediátricas": "100 mg/mL", "Tabletas": "500 mg"}, "doses": {"Perros": [{"purpose": "Analgésico/Antipirético", "dose_range_min": 10, "dose_range_rec": 12, "dose_range_max": 15, "unit": "mg/kg", "route": "PO", "frequency": "c/8-12h"}]}, "functions": ["Analgésico y antipirético no opiáceo. Su uso en veterinaria es muy limitado y riesgoso."], "recommendations": ["USAR SOLO EN PERROS BAJO ESTRICTA SUPERVISIÓN VETERINARIA. Es preferible usar AINEs aprobados para uso veterinario."], "precautions": ["Alto riesgo de hepatotoxicidad y metahemoglobinemia, especialmente a dosis altas o con uso prolongado."], "contraindications": ["ABSOLUTAMENTE CONTRAINDICADO EN GATOS Y HURONES. No usar en perros con enfermedad hepática o renal."], "interactions": {"summary": "El riesgo de toxicidad aumenta con fármacos que afectan el metabolismo hepático.", "specifics": [{"drug": "Fenobarbital", "effect": "Aumenta el riesgo de hepatotoxicidad"}]}, "substitutes": ["Carprofeno", "Galliprant", "Meloxicam"]},
            {"name": "Domperidona", "commercial_names": ["Motilium®"], "concentration": {"Tabletas": "10 mg"}, "doses": {"Perros": [{"purpose": "Antiemético/procinético", "dose_range_min": 0.1, "dose_range_rec": 0.5, "dose_range_max": 0.5, "unit": "mg/kg", "route": "PO", "frequency": "c/8h"}], "Gatos": [], "Caballos": []}, "functions": "Antagonista dopaminérgico periférico, antiemético y procinético.", "recommendations": "Usar con precaución en pacientes con obstrucción GI.", "precautions": "Puede provocar hiperprolactinemia.", "contraindications": "Obstrucción o perforación GI.", "interactions": {"summary": "Potencia efectos de otros depresores GI.", "specifics": []}, "substitutes": ["Metoclopramida"]},
            {"name": "Praziquantel", "commercial_names": ["Droncit®"], "concentration": {"Tabletas": "50 mg"}, "doses": {"Perros": [{"purpose": "Cestodosis (tenias)", "dose_range_min": 5, "dose_range_rec": 5, "dose_range_max": 10, "unit": "mg/kg", "route": "PO", "frequency": "dosis única"}], "Gatos": [{"purpose": "Cestodosis (tenias)", "dose_range_min": 5, "dose_range_rec": 5, "dose_range_max": 10, "unit": "mg/kg", "route": "PO", "frequency": "dosis única"}], "Aves": [{"purpose": "Cestodosis", "dose_range_min": 5, "dose_range_rec": 10, "dose_range_max": 15, "unit": "mg/kg", "route": "PO", "frequency": "dosis única"}], "Reptiles": [{"purpose": "Cestodosis", "dose_range_min": 5, "dose_range_rec": 10, "dose_range_max": 20, "unit": "mg/kg", "route": "PO", "frequency": "dosis única"}]}, "functions": "Antiparasitario cestodicida.", "recommendations": "Administrar con alimento si es posible.", "precautions": "Evitar sobredosificación.", "contraindications": "Hipersensibilidad.", "interactions": {"summary": "Sin interacciones clínicas relevantes conocidas.", "specifics": []}, "substitutes": ["Epsiprantel"]},
            {"name": "Enrofloxacina", "commercial_names": ["Baytril®"], "concentration": {"Tabletas": "100 mg", "Inyectable": "50 mg/mL"}, "doses": {"Perros": [{"purpose": "Infecciones generales", "dose_range_min": 5, "dose_range_rec": 10, "dose_range_max": 20, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}, {"purpose": "Infecciones severas (hospitalaria)", "dose_range_min": 5, "dose_range_rec": 7.5, "dose_range_max": 10, "unit": "mg/kg", "route": "IV/SC", "frequency": "c/12h"}], "Gatos": [{"purpose": "Infecciones generales", "dose_range_min": 5, "dose_range_rec": 5, "dose_range_max": 5, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}], "Caballos": [{"purpose": "Infecciones bacterianas", "dose_range_min": 5, "dose_range_rec": 7.5, "dose_range_max": 10, "unit": "mg/kg", "route": "IV", "frequency": "c/24h"}], "Roedores": [{"purpose": "Infecciones respiratorias", "dose_range_min": 10, "dose_range_rec": 10, "dose_range_max": 10, "unit": "mg/kg", "route": "PO", "frequency": "c/12h"}], "Aves": [{"purpose": "Infecciones respiratorias", "dose_range_min": 15, "dose_range_rec": 17.5, "dose_range_max": 20, "unit": "mg/kg", "route": "PO/SC", "frequency": "c/12h"}], "Reptiles": [{"purpose": "Infecciones generales", "dose_range_min": 5, "dose_range_rec": 7.5, "dose_range_max": 10, "unit": "mg/kg", "route": "SC", "frequency": "c/24h"}]}, "functions": "Fluoroquinolona antibacteriana de amplio espectro.", "recommendations": "Evitar en animales jóvenes por riesgo sobre cartílago en crecimiento.", "precautions": "Riesgo ocular en gatos a dosis altas.", "contraindications": "No administrar en animales gestantes sin evaluación.", "interactions": {"summary": "Quelación con cationes disminuye absorción.", "specifics": []}, "substitutes": ["Marbofloxacina", "Ciprofloxacina"]},
            {"name": "Meloxicam", "commercial_names": ["Metacam®"], "concentration": {"Solución_oral": "1.5 mg/mL", "Inyectable": "5 mg/mL"}, "doses": {"Perros": [{"purpose": "Dolor agudo/postoperatorio (inicial)", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.2, "unit": "mg/kg", "route": "SC/PO", "frequency": "dosis única inicial"}, {"purpose": "Mantenimiento dolor crónico", "dose_range_min": 0.05, "dose_range_rec": 0.1, "dose_range_max": 0.1, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}], "Gatos": [{"purpose": "Dolor postoperatorio (dosis inicial)", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.2, "unit": "mg/kg", "route": "SC", "frequency": "dosis única"}, {"purpose": "Mantenimiento", "dose_range_min": 0.05, "dose_range_rec": 0.05, "dose_range_max": 0.05, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}], "Hurones": [{"purpose": "Dolor/inflamación", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.2, "unit": "mg/kg", "route": "SC/PO", "frequency": "c/24h"}], "Reptiles": [{"purpose": "Analgesia/antinflamatorio", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.2, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}]}, "functions": "AINE para dolor e inflamación.", "recommendations": "Usar la dosis más baja efectiva; monitorear función renal/hepática.", "precautions": "Riesgo GI y renal, especial atención en gatos.", "contraindications": "Insuficiencia renal/hepática severa.", "interactions": {"summary": "Aumento de riesgo con otros AINEs o corticosteroides.", "specifics": []}, "substitutes": ["Carprofeno", "Robenacoxib"]},
            {"name": "Ivermectina", "commercial_names": ["Ivomec®"], "concentration": {"Solución_inyectable": "1% (10 mg/mL)"}, "doses": {"Perros": [{"purpose": "Endectocida profilaxis/uso tópico o subcutáneo", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.4, "unit": "mg/kg", "route": "SC/PO", "frequency": "según indicación (ej. c/30d)"}], "Gatos": [{"purpose": "Endectocida (parásitos externos)", "dose_range_min": 0.2, "dose_range_rec": 0.25, "dose_range_max": 0.3, "unit": "mg/kg", "route": "SC", "frequency": "c/30d"}], "Conejos": [{"purpose": "Sarna", "dose_range_min": 0.4, "dose_range_rec": 0.4, "dose_range_max": 0.4, "unit": "mg/kg", "route": "SC", "frequency": "c/10-14d (x3)"}], "Aves": [{"purpose": "Endectocida", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.3, "unit": "mg/kg", "route": "PO/SC", "frequency": "según especie"}], "Reptiles": [{"purpose": "Endectocida/ectoparásitos", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.4, "unit": "mg/kg", "route": "SC/PO", "frequency": "según especie"}]}, "functions": "Endectocida contra nematodos y ectoparásitos.", "recommendations": "Evitar en razas con mutación MDR1 (perros).", "precautions": "Toxicidad neurológica en individuos sensibles.", "contraindications": "Perros con mutación MDR1; hipersensibilidad.", "interactions": {"summary": "Potencial interacción con otros depresores del SNC.", "specifics": []}, "substitutes": ["Moxidectina", "Selamectina"]},
            {"name": "Fenbendazol", "commercial_names": ["Panacur®"], "concentration": {"Polvo": "100 mg/g"}, "doses": {"Perros": [{"purpose": "Nematodos intestinales", "dose_range_min": 50, "dose_range_rec": 50, "dose_range_max": 50, "unit": "mg/kg", "route": "PO", "frequency": "c/24h x3d"}], "Hurones": [{"purpose": "Giardia/parasitos", "dose_range_min": 20, "dose_range_rec": 20, "dose_range_max": 20, "unit": "mg/kg", "route": "PO", "frequency": "c/24h x5d"}], "Roedores": [{"purpose": "Helmintos", "dose_range_min": 20, "dose_range_rec": 20, "dose_range_max": 50, "unit": "mg/kg", "route": "PO", "frequency": "varía según especie"}], "Aves": [{"purpose": "Coccidios (algunas especies)", "dose_range_min": 20, "dose_range_rec": 20, "dose_range_max": 20, "unit": "mg/kg", "route": "PO", "frequency": "según protocolo"}]}, "functions": "Benzimidazol antiparasitario de amplio espectro.", "recommendations": "Ajustar duración según especie y parasito.", "precautions": "Uso con precaución en animales debilitados.", "contraindications": "Hipersensibilidad.", "interactions": {"summary": "Pocas interacciones clínicamente relevantes.", "specifics": []}, "substitutes": ["Albendazol", "Mebendazol"]},
            {"name": "Ivermectina_topica", "commercial_names": ["Sello topico (ej.)"], "concentration": {"Loción": "variable"}, "doses": {"Aves": [{"purpose": "Tratamiento de ectoparásitos", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.3, "unit": "mg/kg", "route": "Topical/PO/SC", "frequency": "según especie y tamaño"}], "Crocodilios": [{"purpose": "Endectocida (uso veterinario especializado)", "dose_range_min": 0.2, "dose_range_rec": 0.2, "dose_range_max": 0.4, "unit": "mg/kg", "route": "SC", "frequency": "según protocolo especial"}]}, "functions": "Endectocida/ectoparasiticida.", "recommendations": "Dosis muy dependiente de especie; usar referencias exóticas.", "precautions": "Toxicidad en especies sensibles.", "contraindications": "No usar sin valoración en especies no referenciadas.", "interactions": {"summary": "No documentadas ampliamente para exóticos.", "specifics": []}, "substitutes": ["Selamectina"]},
            {"name": "Piperacilina-Tazobactam", "commercial_names": ["Tazocin®"], "concentration": {"Polvo_reconstituir": "4.5 g"}, "doses": {"Perros": [{"purpose": "Infecciones graves (IV)", "dose_range_min": 100, "dose_range_rec": 150, "dose_range_max": 200, "unit": "mg/kg", "route": "IV", "frequency": "c/8h"}], "Gatos": [{"purpose": "Infecciones graves (IV)", "dose_range_min": 100, "dose_range_rec": 150, "dose_range_max": 200, "unit": "mg/kg", "route": "IV", "frequency": "c/8h"}], "Caballos": [{"purpose": "Infecciones graves (IV)", "dose_range_min": 25, "dose_range_rec": 30, "dose_range_max": 40, "unit": "mg/kg", "route": "IV", "frequency": "c/8h"}]}, "functions": "Penicilina amplia combinada con inhibidor de beta-lactamasa.", "recommendations": "Reservar para infecciones severas; ajuste renal si necesario.", "precautions": "Riesgo de irritación venosa y alergia.", "contraindications": "Alergia a betalactámicos.", "interactions": {"summary": "No administrar con aminoglucósidos en la misma jeringa.", "specifics": []}, "substitutes": ["Piperacilina sola", "Carbapenems"]},
            {"name": "Voriconazol", "commercial_names": ["Vfend®"], "concentration": {"Tabletas": "200 mg", "Tópico": "variable", "Otic": "variable", "Inyectable": "variable", "Polvo": "variable"}, "doses": {"Perros": [{"purpose": "Antifúngico de amplio espectro (Aspergilosis, Fusarium)", "dose_range_min": 3, "dose_range_rec": 5, "dose_range_max": 6, "unit": "mg/kg", "route": "PO", "frequency": "c/12h"}], "Gatos": [{"purpose": "Antifúngico de amplio espectro", "dose_range_min": 3, "dose_range_rec": 5, "dose_range_max": 6, "unit": "mg/kg", "route": "PO", "frequency": "c/12h"}]}, "functions": "Antifúngico triazol de segunda generación. Tiene un espectro más amplio que el itraconazol, incluyendo cepas de Aspergillus resistentes.", "recommendations": "Reservado para infecciones fúngicas graves y resistentes. Requiere monitoreo de niveles séricos.", "precautions": "Puede causar hepatotoxicidad y trastornos neurológicos y visuales.", "contraindications": "Enfermedad hepática severa.", "interactions": {"summary": "Interactúa con muchos fármacos a través del sistema CYP450.", "specifics": []}, "substitutes": ["Anfotericina B", "Itraconazol"]},
            {"name": "Warfarina Sódica", "commercial_names": ["Coumadin®"], "concentration": {"Tabletas": "5 mg"}, "doses": {"Perros": [{"purpose": "Anticoagulante a largo plazo (raro)", "dose_range_min": 0.05, "dose_range_rec": 0.1, "dose_range_max": 0.2, "unit": "mg/kg", "route": "PO", "frequency": "c/24h"}]}, "functions": "Anticoagulante cumarínico. Inhibe la activación de los factores de coagulación dependientes de la Vitamina K (II, VII, IX, X).", "recommendations": "SU USO TERAPÉUTICO EN VETERINARIA ES EXTREMADAMENTE RARO debido a la dificultad de monitoreo y al alto riesgo de hemorragia. Es más conocido como rodenticida.", "precautions": "El principal riesgo es la hemorragia espontánea.", "contraindications": "Hemorragia activa, gestación.", "interactions": {"summary": "Innumerables interacciones farmacológicas que potencian o disminuyen su efecto.", "specifics": []}, "substitutes": ["Clopidogrel", "Heparinas", "Rivaroxaban"]},
            {"name": "Xilazina HCl", "commercial_names": ["Anased®", "Rompun®", "Rompun® (Elanco)", "Xilacina 10%"], "concentration": {"Solución Inyectable": "20 mg/mL (pequeños animales), 100 mg/mL (grandes animales)"}, "functions": "Agonista alfa-2 adrenérgico. Produce sedación, analgesia visceral y relajación muscular. También es un emético fiable en gatos.", "recommendations": "Los rumiantes son extremadamente sensibles. La dosis en bovinos es aproximadamente 1/10 de la dosis equina. Sus efectos son reversibles con yohimbina o tolazolina.", "precautions": "Causa vómitos (especialmente en gatos), bradicardia, bloqueo AV e hipotensión. Puede causar timpanismo en rumiantes.", "contraindications": "Enfermedad cardiaca o respiratoria severa, gestación avanzada.", "interactions": {"summary": "Potencia el efecto de otros depresores del SNC.", "specifics": []}, "substitutes": ["Detomidina (en caballos)", "Dexmedetomidina (más específica, reversible con atipamezol)"]},
            {"name": "Yohimbina HCl", "commercial_names": ["Genérico"], "concentration": {"Solución Inyectable": "2 mg/mL"}, "functions": "Antagonista alfa-2 adrenérgico. Se utiliza para revertir los efectos sedantes y cardiovasculares de la xilazina y la amitraz.", "recommendations": "Ha sido mayormente reemplazada por antagonistas más específicos como el atipamezol para la reversión de la dexmedetomidina.", "precautions": "La reversión puede ser rápida y causar excitación y taquicardia.", "contraindications": "Hipersensibilidad.", "interactions": {"summary": "No se han reportado interacciones.", "specifics": []}, "substitutes": ["Atipamezol", "Tolazolina"]}
        ].sort((a, b) => a.name.localeCompare(b.name));
        
        // --- NEW DATA STRUCTURES ---
        const physiologicalConstants = {
            'Perros': { 'Temp °C': '37.5-39.2', 'FC (lpm)': '60-140', 'FR (rpm)': '10-30', 'PAS (mmHg)': '90-140' },
            'Gatos': { 'Temp °C': '38.0-39.2', 'FC (lpm)': '140-220', 'FR (rpm)': '20-40', 'PAS (mmHg)': '80-130' },
            'Bovinos': { 'Temp °C': '38.0-39.5', 'FC (lpm)': '40-80', 'FR (rpm)': '10-30', 'PAS (mmHg)': '100-140' },
            'Equinos': { 'Temp °C': '37.5-38.5', 'FC (lpm)': '28-44', 'FR (rpm)': '8-16', 'PAS (mmHg)': '90-130' },
            'Ovinos': { 'Temp °C': '38.5-40.0', 'FC (lpm)': '70-90', 'FR (rpm)': '12-25', 'PAS (mmHg)': '90-130' },
            'Caprinos': { 'Temp °C': '38.5-40.5', 'FC (lpm)': '70-90', 'FR (rpm)': '15-30', 'PAS (mmHg)': '90-130' },
            'Porcinos': { 'Temp °C': '38.0-39.5', 'FC (lpm)': '70-120', 'FR (rpm)': '30-45', 'PAS (mmHg)': '100-150' },
            'Conejos': { 'Temp °C': '38.5-40.0', 'FC (lpm)': '180-350', 'FR (rpm)': '30-60', 'PAS (mmHg)': '90-130' },
            'Hurones': { 'Temp °C': '37.8-39.4', 'FC (lpm)': '180-250', 'FR (rpm)': '33-36', 'PAS (mmHg)': '120-160' },
            'Cobayos': { 'Temp °C': '37.2-39.5', 'FC (lpm)': '230-380', 'FR (rpm)': '45-110', 'PAS (mmHg)': '90-120' },
            'Psitácidas (promedio)': { 'Temp °C': '40.0-42.0', 'FC (lpm)': '250-600', 'FR (rpm)': '25-50', 'PAS (mmHg)': 'N/A' },
            'Iguanas': { 'Temp °C': '28.0-35.0 (gradiente)', 'FC (lpm)': '40-60', 'FR (rpm)': '10-20', 'PAS (mmHg)': 'N/A' },
        };

        const anestheticProtocols = [
            // --- PERROS ---
            { name: 'Perro Sano (ASA I/II) - Reversible', species: 'Perros', asa: 'I-II', premed: 'Dexmedetomidina (2-5 mcg/kg) + Butorfanol (0.2-0.4 mg/kg) IM.', induction: 'Propofol (2-4 mg/kg) o Alfaxalona (1-2 mg/kg) IV a efecto.', maintenance: 'Isoflurano / Sevoflurano.', notes: 'Buena sedación y analgesia, totalmente reversible con Atipamezol. Ideal para procedimientos de rutina.' },
            { name: 'Perro Sano (ASA I/II) - Opción Clásica', species: 'Perros', asa: 'I-II', premed: 'Acepromacina (0.02-0.05 mg/kg) + Buprenorfina (0.01-0.02 mg/kg) IM.', induction: 'Propofol (3-5 mg/kg) IV a efecto.', maintenance: 'Isoflurano.', notes: 'Buena sedación, pero no es reversible y puede causar hipotensión. Requiere buen monitoreo.' },
            { name: 'Perro Geriátrico/Débil (ASA III/IV)', species: 'Perros', asa: 'III-IV', premed: 'Midazolam (0.2-0.3 mg/kg) + Fentanilo (2-5 mcg/kg) IV lento.', induction: 'Etomidato (1-2 mg/kg) o Alfaxalona (1-2 mg/kg) IV. Alternativa: Propofol a dosis reducida (1-2 mg/kg) co-inducido con Midazolam.', maintenance: 'Isoflurano / Sevoflurano a la CAM más baja posible.', notes: 'Protocolo enfocado en la máxima estabilidad cardiovascular.' },
            { name: 'Perro para Cesárea', species: 'Perros', asa: 'II-III', premed: 'Bajo o nulo. Considerar opioide de acción corta (Fentanilo 2 mcg/kg IV) justo antes de la inducción.', induction: 'Propofol (3-6 mg/kg) o Alfaxalona (2-3 mg/kg) IV a efecto (rápido para minimizar depresión fetal).', maintenance: 'Isoflurano. Anestesia epidural es la mejor opción para la analgesia.' },
            { name: 'Perro Braquicéfalo', species: 'Perros', asa: 'II-III', premed: 'Maropitant (1 mg/kg) SC 1h antes. Butorfanol (0.2 mg/kg) + Midazolam (0.2 mg/kg) IM.', induction: 'Inducción rápida con Propofol (3-5 mg/kg) IV y asegurar vía aérea inmediatamente (intubación).', maintenance: 'Isoflurano / Sevoflurano.', notes: 'Pre-oxigenar por 5 minutos es crucial. Mantener intubado el mayor tiempo posible durante la recuperación.' },
            
            // --- GATOS ---
            { name: 'Gato Sano (ASA I/II) - "Kitty Magic" Mejorado', species: 'Gatos', asa: 'I-II', premed: 'Dexmedetomidina (5-10 mcg/kg) + Ketamina (3-5 mg/kg) + Buprenorfina (0.02 mg/kg) IM, todo en la misma jeringa.', induction: 'Puede no ser necesaria, o complementar com Propofol/Alfaxalona IV a efecto.', maintenance: 'Isoflurano / Sevoflurano.', notes: 'Excelente inmovilización y analgesia. Reversible (Atipamezol revierte Dexmedetomidina).' },
            { name: 'Gato Obstruido/Urgencia (ASA IV)', species: 'Gatos', asa: 'IV', premed: 'Butorfanol (0.2-0.4 mg/kg) + Midazolam (0.2 mg/kg) IM. Evitar α2-agonistas y Ketamina.', induction: 'Propofol (dosis bajas, 2-4 mg/kg) o Alfaxalona (1-2 mg/kg) IV. Anestesia epidural es altamente recomendada.', maintenance: 'Sevoflurano (rápida eliminación).', notes: 'Enfoque en estabilización primero. Corregir hiperkalemia y deshidratación antes de anestesiar.' },
            { name: 'Gato Agresivo para Sedación', species: 'Gatos', asa: 'I-II', premed: 'Gabapentina oral (100 mg/gato) 2-3 horas antes de la cita. En clínica: Tiletamina/Zolazepam (Zoletil®) (2-4 mg/kg) IM.', induction: 'N/A para sedación.', maintenance: 'N/A', notes: 'Zoletil proporciona una sedación profunda y rápida. La premedicación oral reduce el estrés.' },

            // --- GRANDES ESPECIES ---
            { name: 'Equino - Sedación de Campo', species: 'Equinos', asa: 'I-III', premed: 'Xilacina (0.5-1.1 mg/kg) IV o Detomidina (10-20 mcg/kg) IV. Esperar efecto máximo.', induction: 'Ketamina (2.2 mg/kg) + Diazepam o Midazolam (0.05-0.1 mg/kg) IV.', maintenance: 'Infusión de "Triple Gota": Guaifenesina 5% (50mg/mL) + Ketamina (2mg/mL) + Xilacina (0.5mg/mL) IV a ritmo de 1-2 mL/kg/hr.', notes: 'Protocolo de TIVA (Anestesia Total Intravenosa) muy común en campo para procedimientos de hasta 60 minutos.' },
            { name: 'Bovino - Sedación y Anestesia Local', species: 'Bovinos', asa: 'I-III', premed: 'Xilacina (0.05-0.1 mg/kg) IM. ¡Los bovinos son muy sensibles!', induction: 'Anestesia local infiltrativa o bloqueo regional (ej. Bloqueo paravertebral) con Lidocaína al 2%.', maintenance: 'N/A', notes: 'Para muchos procedimientos de campo (cirugía de flanco, etc.), la sedación profunda com anestesia local es suficiente y más segura que la anestesia general.' },
            { name: 'Sedación con Xilacina', species: 'Perros', asa: 'I-II', premed: 'N/A', induction: 'Xilacina (0.5-1 mg/kg) IV o IM', maintenance: 'N/A', notes: 'Agonista alfa-2 adrenérgico. Produce sedación, relajación muscular y analgesia. Puede causar bradicardia y depresión respiratoria. Reversible con yohimbina o atipamezol.'},
            { name: 'Anestesia con Zoletil', species: 'Perros', asa: 'II-III', premed: 'N/A', induction: 'Tiletamina/Zolazepam (Zoletil®) (6-10 mg/kg) IM', maintenance: 'N/A', notes: 'Anestésico disociativo. Proporciona inmovilización rápida, pero no es un relajante muscular completo.'},
        ];
        const SEDATIVE_ANESTHETIC_DRUGS = [
            "Ketanil® (Ketamina 200 mg/mL)",
            "Ketovet (Ketamina)",
            "Kronamina Vet® (Dexmedetomidina)",
            "Xilacina al 10% (Clorhidrato de Xilacina)",
            "Zoletil 100 (Tiletamina + Zolazepam)"
        ];

        const lifeStages = {
            'Perros': [
                { stage: 'Cachorro', maxAgeMonths: 12 },
                { stage: 'Adulto', maxAgeMonths: 84 },
                { stage: 'Geriátrico', maxAgeMonths: Infinity }
            ],
            'Gatos': [
                { stage: 'Gatito', maxAgeMonths: 12 },
                { stage: 'Adulto', maxAgeMonths: 96 },
                { stage: 'Geriátrico', maxAgeMonths: Infinity }
            ],
            'Equinos': [
                { stage: 'Potro', maxAgeMonths: 12 },
                { stage: 'Joven', maxAgeMonths: 48 },
                { stage: 'Adulto', maxAgeMonths: 240 },
                { stage: 'Geriátrico', maxAgeMonths: Infinity }
            ],
            'Bovinos': [
                { stage: 'Ternero', maxAgeMonths: 12 },
                { stage: 'Novillo', maxAgeMonths: 36 },
                { stage: 'Adulto', maxAgeMonths: 120 },
                { stage: 'Geriátrico', maxAgeMonths: Infinity }
            ],
            // Puedes añadir más especies aquí
            'default': [
                { stage: 'Joven', maxAgeMonths: 12 },
                { stage: 'Adulto', maxAgeMonths: 120 },
                { stage: 'Geriátrico', maxAgeMonths: Infinity }
            ]
        };
        
        // --- Reusable Info Card Component (GLOBAL SCOPE) ---
        const InfoCard = ({ icon, title, color, children }) => {
            if (!children || (Array.isArray(children) && children.length === 0)) return null;
            const colorClasses = {
                red: 'border-red-500/50 bg-red-500/10 text-red-300',
                yellow: 'border-yellow-500/50 bg-yellow-500/10 text-yellow-300',
                blue: 'border-blue-500/50 bg-blue-500/10 text-blue-300',
                green: 'border-green-500/50 bg-green-500/10 text-green-300',
                purple: 'border-purple-500/50 bg-purple-500/10 text-purple-300',
                indigo: 'border-indigo-500/50 bg-indigo-500/10 text-indigo-300',
            };

            return (
                <div className={`p-3 rounded-lg border ${colorClasses[color]}`}>
                    <div className="flex items-center mb-1">
                        {icon}
                        <h3 className={`ml-2 font-bold text-xs uppercase tracking-wider text-${color}-400`}>{title}</h3>
                    </div>
                    <div className="text-gray-300 text-xs pl-6 prose prose-sm" dangerouslySetInnerHTML={{ __html: String(children).replace(/\n/g, '<br/>') }} />
                </div>
            );
        };
        
        // --- Reusable Medication Info Display (GLOBAL SCOPE) ---
        const MedicationInfo = ({ medData }) => {
            if(!medData) return null;
            const functions = Array.isArray(medData.functions) ? medData.functions.join(' ') : medData.functions;
            const recommendations = Array.isArray(medData.recommendations) ? medData.recommendations.join(' ') : medData.recommendations;
            const precautions = Array.isArray(medData.precautions) ? medData.precautions.join(' ') : medData.precautions;
            const contraindications = Array.isArray(medData.contraindications) ? medData.contraindications.join(' ') : medData.contraindications;
            const interactions = medData.interactions?.summary + (medData.interactions?.specifics?.map(i => `<br/>- ${i.drug}: ${i.effect}`).join('') || '');
            const substitutes = Array.isArray(medData.substitutes) ? medData.substitutes.join(', ') : medData.substitutes;
            return(
                <div className="pt-4 border-t border-slate-700">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                        <InfoCard icon={<Zap size={16} className="text-green-400"/>} title="Función" color="green">{functions}</InfoCard>
                        <InfoCard icon={<Lightbulb size={16} className="text-blue-400"/>} title="Recomendaciones" color="blue">{recommendations}</InfoCard>
                        <InfoCard icon={<AlertTriangle size={16} className="text-yellow-400"/>} title="Precauciones" color="yellow">{precautions}</InfoCard>
                        <InfoCard icon={<Slash size={16} className="text-red-400"/>} title="Contraindicaciones" color="red">{contraindications}</InfoCard>
                        <InfoCard icon={<Users size={16} className="text-purple-400"/>} title="Interacciones" color="purple">{interactions}</InfoCard>
                        <InfoCard icon={<Shuffle size={16} className="text-indigo-400"/>} title="Sustitutos" color="indigo">{substitutes}</InfoCard>
                    </div>
                </div>
            );
        }
        
        // --- HELPER & TOOL COMPONENTS ---
        const InfoTooltip = ({ text }) => (
            <div className="tooltip ml-1">
                <HelpCircle size={14} className="text-gray-400" />
                <span className="tooltiptext">{text}</span>
            </div>
        );

        const HistoryModal = ({ history, onClose, onRestore }) => {
            const userId = history.length > 0 ? history[0].userId : 'N/A';
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl p-6 h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">Historial de Dosis</h2>
                            <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <p className="text-sm text-gray-400 mb-4">ID de usuario: <span className="font-mono text-xs">{userId}</span></p>
                        <ul className="space-y-3 overflow-y-auto flex-grow pr-2">
                            {history.length > 0 ? history.map(entry => (
                                <li key={entry.id} className="bg-slate-700/50 p-3 rounded-lg">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-white">{entry.patient.name} <span className="text-sm font-normal text-gray-400">({entry.patient.species}{entry.patient.subSpecies ? `/${entry.patient.subSpecies}`:''}, {entry.patient.weight}kg)</span></p>
                                            <p className="text-xs text-gray-300 mt-1 truncate">{entry.medications.map(med => med.name.split('(')[0].trim()).join(', ')}</p>
                                            <p className="text-xs text-gray-400">{entry.timestamp}</p>
                                        </div>
                                        <button onClick={() => onRestore(entry)} className="p-2 text-blue-400 hover:text-white" title="Restaurar datos"><PlusCircle size={20}/></button>
                                    </div>
                                </li>
                            )) : <p className="text-center text-gray-400">No hay dosis guardadas.</p>}
                        </ul>
                    </div>
                </div>
            )
        };

        const InfoModal = ({ title, onClose, children }) => {
            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 z-[100] flex justify-center items-center p-4">
                    <div className="bg-slate-800 rounded-lg shadow-xl w-full max-w-lg p-6 relative h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-slate-800 py-2">
                            <h2 className="text-2xl font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="prose prose-invert max-w-none text-gray-300">
                           {children}
                        </div>
                    </div>
                </div>
            );
        };
        
        const EmergencyMode = ({ onExit }) => {
            const emergencyDrugs = [
                { name: 'Adrenalina (1 mg/mL)', dose: 0.01, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/1, info: 'Para PCR o shock anafiláctico. Diluir 1:10 para uso IV (0.1 mg/mL).' },
                { name: 'Atropina (0.5 mg/mL)', dose: 0.02, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/0.5, info: 'Para bradicardia severa. Dosis en mL es 0.04 x peso en kg.' },
                { name: 'Diazepam (5 mg/mL)', dose: 0.5, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/5, info: 'Para estado epiléptico. Administrar IV lenta.' },
                { name: 'Lidocaína 2% (20 mg/mL)', dose: 2, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/20, info: 'Para arritmias ventriculares. Usar bolo de 2 mg/kg, seguido de CRI.' },
                { name: 'Dexametasona (2 mg/mL)', dose: 0.5, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/2, info: 'Dosis de shock. Para trauma o anafilaxia.' },
                { name: 'Furosemida (50 mg/mL)', dose: 2, unit: 'mg/kg', resultUnit: 'mL/kg', calculation: (w,d) => (w*d)/50, info: 'Para edema pulmonar. Dosis de 2-4 mg/kg IV.' },
            ];
            const weightRanges = [[1, 5], [5, 10], [10, 20], [20, 40], [40, 60]];
            const [selectedDrug, setSelectedDrug] = React.useState(emergencyDrugs[0]);

            const calculateTable = (drug) => {
                return weightRanges.map(range => {
                    const avgWeight = (range[0] + range[1]) / 2;
                    const dose = drug.calculation(avgWeight, drug.dose);
                    return { range: `${range[0]}-${range[1]} kg`, dose: `${dose.toFixed(2)} mL` };
                });
            };
            
            return (
                <div className="fixed inset-0 bg-red-900 text-white p-4 font-sans flex flex-col items-center z-50 overflow-y-auto">
                    <h1 className="text-4xl font-bold mb-4 animate-pulse">MODO EMERGENCIA</h1>
                    <div className="w-full max-w-2xl bg-slate-800 p-6 rounded-lg">
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                            {emergencyDrugs.map(drug => (
                                <button key={drug.name} onClick={() => setSelectedDrug(drug)} className={`p-3 rounded-lg transition-colors ${selectedDrug?.name === drug.name ? 'bg-yellow-500 text-black' : 'bg-red-700 hover:bg-red-600'}`}>
                                    {drug.name.split('(')[0]}
                                </button>
                            ))}
                        </div>
                        {selectedDrug && (
                            <div>
                                <h2 className="text-2xl font-bold mb-2 text-yellow-400">{selectedDrug.name}</h2>
                                <p className="mb-4 text-sm font-normal text-gray-300">{selectedDrug.info}</p>
                                <table className="w-full text-left">
                                    <thead><tr className="bg-slate-700"><th className="p-2">Rango de Peso</th><th className="p-2">Dosis a Administrar (Promedio)</th></tr></thead>
                                    <tbody>{calculateTable(selectedDrug).map(row => (<tr key={row.range} className="border-b border-slate-600"><td className="p-2">{row.range}</td><td className="p-2 font-bold">{row.dose}</td></tr>))}</tbody>
                                </table>
                            </div>
                        )}
                    </div>
                    <button onClick={onExit} className="mt-6 px-6 py-2 bg-slate-700 rounded-lg hover:bg-slate-600">Salir de Modo Emergencia</button>
                </div>
            );
        };
        
        const FluidTherapyCalculator = ({ onClose, speciesList, speciesEmojis, patient, allMedications }) => {
            const [state, setState] = React.useState({ 
                weight: patient.weight || '', 
                dehydration: 5, 
                maintenance: 60, 
                losses: 0, 
                duration: 24, 
                dripFactor: 20,
                bagVolume: 1000
            });
            const [showInfo, setShowInfo] = React.useState(false);
            
            React.useEffect(() => {
                // Sincronizar el peso del paciente
                setState(prev => ({...prev, weight: patient.weight}));
            }, [patient.weight]);

            const handleChange = e => {
                setState(prevState => ({ ...prevState, [e.target.name]: e.target.value }));
            };

            const { weight, dehydration, maintenance, losses, duration, dripFactor, bagVolume } = state;
            const weightNum = parseFloat(weight) || 0;
            const dehydrationNum = parseFloat(dehydration) || 0;
            const maintenanceNum = parseFloat(maintenance) || 0;
            const lossesNum = parseFloat(losses) || 0;
            const durationNum = parseFloat(duration) || 0;
            const dripFactorNum = parseFloat(dripFactor) || 0;
            const bagVolumeNum = parseFloat(bagVolume) || 0;

            const rehydrationMl = weightNum * dehydrationNum * 10;
            const maintenanceMl = weightNum * maintenanceNum;
            const totalMlDay = rehydrationMl + maintenanceMl + lossesNum;
            const rateMlHr = durationNum > 0 ? totalMlDay / durationNum : 0;
            
            const bagDurationHrs = rateMlHr > 0 ? bagVolumeNum / rateMlHr : 0;
            const bagDrops = bagVolumeNum * dripFactorNum;
            const bagSeconds = bagDurationHrs * 3600;
            const secondsPerDrop = bagSeconds > 0 ? bagSeconds / bagDrops : 0;

            return (
                <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                    {showInfo && <InfoModal title="Información General de Fluidoterapia" onClose={() => setShowInfo(false)}>
                        <h3>¿Qué es? </h3>
                        <p>Es una de las terapias más importantes en medicina veterinaria, usada para corregir deshidratación, mantener la hidratación, reponer electrolitos y administrar medicamentos.</p>
                        <h3>¿Cuándo usarla? </h3>
                        <p>En pacientes deshidratados, en shock, anoréxicos, con vómitos/diarrea, durante y después de cirugías, o con enfermedades renales.</p>
                        <h3>Fórmulas Clave:</h3>
                        <p><code>Déficit (Rehidratación) = Peso (kg) * % Deshidratación * 10</code></p>
                        <p><code>Mantenimiento = Peso (kg) * Tasa (mL/kg/día)</code></p>
                        <p><code>Total 24h = Déficit + Mantenimiento + Pérdidas</code></p>
                    </InfoModal>}
                    <div className="bg-slate-900 rounded-lg w-full p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">Calculadora de Fluidoterapia</h2>
                            <div className="flex items-center gap-2">
                               <button onClick={() => setShowInfo(true)} className="p-2 text-gray-400 hover:text-white"><HelpCircle size={24} /></button>
                               <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Peso (kg) <InfoTooltip text="Peso actual del paciente en kilogramos." /></label>
                                <input type="number" name="weight" value={weight} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">% Deshidratación <InfoTooltip text="Estimación clínica. 5% leve (mucosas pegajosas), 8% moderada (ojos hundidos), 10%+ severa (shock)." /></label>
                                <input type="number" name="dehydration" value={dehydration} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Mantenimiento (mL/kg/día) <InfoTooltip text="Tasa estándar para cubrir necesidades diarias. Común: 40-60 mL/kg/día." /></label>
                                <input type="number" name="maintenance" value={maintenance} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Pérdidas Anormales (mL/día) <InfoTooltip text="Estimar volumen perdido por vómito, diarrea, etc., en 24h." /></label>
                                <input type="number" name="losses" value={losses} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Tiempo de Administración (horas) <InfoTooltip text="Duración total de la terapia en horas. Recomendado: 24h." /></label>
                                <input type="number" name="duration" value={duration} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                             <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Volumen de Suero <InfoTooltip text="Volumen de la bolsa de suero que se utilizará." /></label>
                                <input type="number" name="bagVolume" value={bagVolume} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                             <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Factor Gotero (gts/mL) <InfoTooltip text="Factor de goteo del equipo de venoclisis (micro=60, macro=10, 15, o 20)." /></label>
                                <select name="dripFactor" value={dripFactor} onChange={handleChange} className="w-full p-2 bg-slate-800 rounded-md">
                                    <option value="10">10 (Macrogoteo)</option>
                                    <option value="15">15 (Macrogoteo)</option>
                                    <option value="20">20 (Macrogoteo)</option>
                                    <option value="60">60 (Microgoteo)</option>
                                </select>
                            </div>
                        </div>
                        {weightNum > 0 && durationNum > 0 && bagVolumeNum > 0 && (
                            <div className="mt-6 p-4 bg-slate-800 rounded-lg">
                                <h3 className="text-lg font-bold text-green-400 mb-2">Resultados del Cálculo:</h3>
                                <p className="text-sm text-gray-300"><strong>Paso 1: Cálculo del volumen total</strong></p>
                                <p className="text-xs text-gray-400 ml-4">Volumen total = (Déficit por rehidratación) + (Mantenimiento) + (Pérdidas)</p>
                                <p className="text-xs text-gray-400 ml-4">Volumen total = ({rehydrationMl.toFixed(2)} mL) + ({maintenanceMl.toFixed(2)} mL) + ({lossesNum.toFixed(2)} mL)</p>
                                <p className="text-sm mt-2">Volumen total: <strong className="text-yellow-400">{totalMlDay.toFixed(2)} mL</strong></p>
                                <p className="text-sm text-gray-300 mt-4"><strong>Paso 2: Cálculo de la tasa de infusión</strong></p>
                                <p className="text-xs text-gray-400 ml-4">Tasa (mL/hr) = Volumen total / Tiempo de administración</p>
                                <p className="text-xs text-gray-400 ml-4">Tasa (mL/hr) = {totalMlDay.toFixed(2)} mL / {durationNum} hr</p>
                                <p className="text-sm mt-2">Tasa de infusión: <strong className="text-yellow-400">{rateMlHr.toFixed(2)} mL/hr</strong></p>
                                <p className="text-sm text-gray-300 mt-4"><strong>Paso 3: Tasa de goteo para la bolsa de suero</strong></p>
                                <p className="text-xs text-gray-400 ml-4">Tiempo por gota = (Volumen de la bolsa * Factor de goteo) / (Tasa de infusión * 3600 segundos)</p>
                                <p className="text-xs text-gray-400 ml-4">Tiempo por gota = ({bagVolumeNum.toFixed(0)} mL * {dripFactorNum} gts/mL) / ({rateMlHr.toFixed(2)} mL/hr * 3600 s)</p>
                                <p className="text-sm mt-2">Duración de la bolsa: <strong className="text-yellow-400">{bagDurationHrs.toFixed(1)} horas</strong></p>
                                <p className="text-sm mt-2">Tasa de goteo: <strong className="text-yellow-400">1 gota cada {secondsPerDrop.toFixed(1)} segundos</strong></p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const DilutionCalculator = ({ onClose, allMedications }) => {
            const [state, setState] = React.useState({ 
                selectedMed: null,
                selectedPresentation: '',
                c1: '', 
                c2: '', 
                v2: '' 
            });
            const [showInfo, setShowInfo] = React.useState(false);
            const [searchTerm, setSearchTerm] = React.useState('');
            const searchRef = React.useRef(null);
            
            const handleSearchChange = (e) => {
                setSearchTerm(e.target.value);
            };

            const handleSelectMed = (med) => {
                setState(prev => ({
                    ...prev,
                    selectedMed: med,
                    selectedPresentation: med.concentration ? Object.keys(med.concentration)[0] : '',
                    c1: med.concentration ? parseFloat(med.concentration[Object.keys(med.concentration)[0]].match(/(\d+\.?\d*)/)?.[0]) || '' : ''
                }));
                setSearchTerm(med.name);
                if (searchRef.current) searchRef.current.blur();
            };

            const handleConcentrationChange = (e) => {
                setState(prev => ({
                    ...prev,
                    c1: e.target.value
                }));
            };

            const handleInputChange = e => {
                setState(prevState => ({ ...prevState, [e.target.name]: e.target.value }));
            };

            const { c1, v2, c2, selectedMed, selectedPresentation } = state;
            const c1Num = parseFloat(c1) || 0;
            const v2Num = parseFloat(v2) || 0;
            const c2Num = parseFloat(c2) || 0;

            let v1 = 0;
            let diluentVolume = 0;
            if (c1Num > 0 && v2Num > 0 && c2Num > 0 && c1Num > c2Num) {
                v1 = (c2Num * v2Num) / c1Num;
                diluentVolume = v2Num - v1;
            }

            const filteredMeds = allMedications.filter(med => 
                med.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (med.commercial_names && med.commercial_names.some(name => name.toLowerCase().includes(searchTerm.toLowerCase())))
            ).slice(0, 10);
            

            return (
                <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                    {showInfo && <InfoModal title="Diluciones (C₁V₁ = C₂V₂)" onClose={() => setShowInfo(false)}>
                        <h3>¿Qué es?</h3>
                        <p>Esta calculadora utiliza la fórmula universal de dilución para determinar el volumen de una solución madre (V₁) necesario para preparar una solución final de una concentración y volumen deseados.</p>
                        <h3>¿Cuándo usarla?</h3>
                        <p>Siempre que necesites preparar una solución menos concentrada a partir de una más concentrada. Ej: preparar una solución de Dexametasona al 0.5% a partir de un vial al 2%.</p>
                        <h3>Fórmula:</h3>
                        <p>V₁ = (C₂ * V₂) / C₁</p>
                        <p><strong>Importante:</strong> Las unidades de concentración (C₁ y C₂) deben ser las mismas (ej. mg/mL, %). Las unidades de volumen (V₁ y V₂) también serán las mismas.</p>
                    </InfoModal>}
                    <div className="bg-slate-900 rounded-lg w-full max-w-lg p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-white">Calculadora de Diluciones</h2>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowInfo(true)} className="p-2 text-gray-400 hover:text-white"><HelpCircle size={24} /></button>
                                <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 gap-4">
                            <div className="relative">
                                <label className="block text-sm font-bold text-gray-300 mb-1">Medicamento</label>
                                <input type="text" value={searchTerm} onChange={handleSearchChange} placeholder="Buscar medicamento..." className="w-full px-4 py-2 bg-slate-800 rounded-md" ref={searchRef} />
                                {searchTerm && (
                                    <ul className="absolute z-10 w-full mt-1 bg-slate-700 border border-slate-600 rounded-lg max-h-40 overflow-y-auto">
                                        {filteredMeds.map(med => (
                                            <li key={med.name} onClick={() => handleSelectMed(med)} className="px-4 py-2 cursor-pointer hover:bg-slate-600">
                                                {med.name}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Concentración Inicial ($C_{1}$) <InfoTooltip text="Concentración de la solución que tienes disponible." /></label>
                                <div className="flex items-center gap-2">
                                    <input type="number" name="c1" value={c1} onChange={handleInputChange} className="w-2/3 p-2 bg-slate-800 rounded-md" placeholder="Ej: 50" />
                                    {selectedMed && selectedPresentation && 
                                        <span className="text-gray-400 text-sm">{selectedMed.concentration[selectedPresentation]}</span>
                                    }
                                </div>
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Volumen Deseado ($V_{2}$) <InfoTooltip text="Volumen total que necesitas preparar de la nueva solución." /></label>
                                <input type="number" name="v2" value={v2} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" placeholder="Ej: 100 (mL)" />
                            </div>
                            <div>
                                <label className="flex items-center text-sm font-bold text-gray-300 mb-1">Concentración Deseada ($C_{2}$) <InfoTooltip text="Concentración que quieres obtener en tu nueva solución." /></label>
                                <input type="number" name="c2" value={c2} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" placeholder="Ej: 5 (mg/mL o %)" />
                            </div>
                        </div>
                        {v1 > 0 && diluentVolume > 0 && <div className="mt-6 p-4 bg-slate-800 rounded-lg text-center">
                            <h3 className="text-lg font-bold text-green-400">Resultados del Cálculo:</h3>
                            <p className="text-xl">Tome <strong className="text-yellow-400">{v1.toFixed(2)} mL</strong> de la solución inicial ({selectedMed?.name})</p>
                            <p className="text-xl">Y añada <strong className="text-yellow-400">{diluentVolume.toFixed(2)} mL</strong> de suero (diluyente) para aforar a <strong>{v2} mL</strong>.</p>
                        </div>}
                    </div>
                </div>
            );
        };
        
        const ToolsMenu = ({ onSelect }) => (
            <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                <h2 className="text-xl font-bold mb-4 text-white text-center">Herramientas y Referencias</h2>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onClick={() => onSelect('addMed')} className="flex flex-col items-center p-4 bg-teal-800/50 rounded-lg hover:bg-teal-700/50 transition-colors col-span-2 md:col-span-4"><FlaskConical className="mb-2 text-teal-400"/>Añadir Fármaco</button>
                    <button onClick={() => onSelect('vademecum')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><BookOpen className="mb-2 text-blue-400"/>Vademécum</button>
                    <button onClick={() => onSelect('constants')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><HeartPulse className="mb-2 text-red-400"/>Constantes</button>
                    <button onClick={() => onSelect('fluid')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><Droplet className="mb-2 text-cyan-400"/>Fluidoterapia</button>
                    <button onClick={() => onSelect('bsa')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><Square className="mb-2 text-purple-400"/>Sup. Corporal</button>
                    <button onClick={() => onSelect('cri')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><Calculator className="mb-2 text-green-400"/>CRI</button>
                    <button onClick={() => onSelect('dilution')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors"><Beaker className="mb-2 text-indigo-400"/>Diluciones</button>
                    <button onClick={() => onSelect('protocols')} className="flex flex-col items-center p-4 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors col-span-2"><Siren className="mb-2 text-yellow-400"/>Protocolos Anest.</button>
                </div>
            </div>
        );

        const VademecumView = ({ allMedications, favorites, toggleFavorite, onClose, handleUpdateUserMed, handleDeleteUserMed, speciesList, exoticSpeciesMap, speciesEmojis, userAddedMedsMap }) => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [selectedMed, setSelectedMed] = React.useState(null);
            const [isEditing, setIsEditing] = React.useState(false);
            const [editableMed, setEditableMed] = React.useState(null);
            const [isDirty, setIsDirty] = React.useState(false);
            const [newCommercialName, setNewCommercialName] = React.useState('');
            const [newSpecies, setNewSpecies] = React.useState('');
            const [newDosePurpose, setNewDosePurpose] = React.useState('');

            React.useEffect(() => {
                if (selectedMed) {
                    setEditableMed(JSON.parse(JSON.stringify(selectedMed)));
                    setIsDirty(false);
                }
            }, [selectedMed]);

            const handleEditChange = (field, value, speciesKey = null, doseIndex = null) => {
                setIsDirty(true);
                setEditableMed(prev => {
                    const newMed = JSON.parse(JSON.stringify(prev));
                    if (field === 'name') newMed.name = value;
                    else if (field === 'concentration') newMed.concentration[value.key] = value.value;
                    else if (field === 'add_concentration') newMed.concentration[value.key] = value.value;
                    else if (field === 'dose_range') {
                        newMed.doses[speciesKey][doseIndex].dose_range_min = value.min;
                        newMed.doses[speciesKey][doseIndex].dose_range_rec = value.rec;
                        newMed.doses[speciesKey][doseIndex].dose_range_max = value.max;
                    }
                    else if (field === 'purpose') newMed.doses[speciesKey][doseIndex].purpose = value;
                    else if (field === 'route') newMed.doses[speciesKey][doseIndex].route = value;
                    else if (field === 'frequency') newMed.doses[speciesKey][doseIndex].frequency = value;
                    return newMed;
                });
            };

            const handleAddCommercialName = () => {
                if(newCommercialName.trim()){
                    setIsDirty(true);
                    setEditableMed(prev => {
                        const newMed = JSON.parse(JSON.stringify(prev));
                        newMed.commercial_names.push(newCommercialName.trim());
                        return newMed;
                    });
                    setNewCommercialName('');
                }
            };
            const handleRemoveCommercialName = (idx) => {
                setIsDirty(true);
                setEditableMed(prev => {
                    const newMed = JSON.parse(JSON.stringify(prev));
                    newMed.commercial_names.splice(idx, 1);
                    return newMed;
                });
            }

            const handleAddSpecies = () => {
                if(newSpecies.trim() && editableMed.doses && !editableMed.doses[newSpecies.trim()]){
                    setIsDirty(true);
                    setEditableMed(prev => {
                        const newMed = JSON.parse(JSON.stringify(prev));
                        if (!newMed.doses) newMed.doses = {};
                        newMed.doses[newSpecies.trim()] = [];
                        return newMed;
                    });
                    setNewSpecies('');
                }
            };

            const handleAddDosePurpose = (speciesKey) => {
                setIsDirty(true);
                setEditableMed(prev => {
                    const newMed = JSON.parse(JSON.stringify(prev));
                    if(!newMed.doses[speciesKey]) newMed.doses[speciesKey] = [];
                    newMed.doses[speciesKey].push({
                         "purpose": newDosePurpose || "Nuevo propósito",
                         "dose_range_min": 0,
                         "dose_range_rec": 0,
                         "dose_range_max": 0,
                         "unit": "mg/kg",
                         "route": "PO",
                         "frequency": "c/24h"
                    });
                    return newMed;
                });
                setNewDosePurpose('');
            };

            const handleSaveEdits = () => {
                handleUpdateUserMed(editableMed);
                setIsEditing(false);
                setSelectedMed(editableMed);
            };

            const filteredMeds = React.useMemo(() => {
                const allFiltered = allMedications.filter(m => searchTerm === '' || m.name.toLowerCase().includes(searchTerm.toLowerCase()) || m.commercial_names.join(' ').toLowerCase().includes(searchTerm.toLowerCase()));
                return allFiltered.sort((a, b) => {
                    const aIsFav = favorites.includes(a.name);
                    const bIsFav = favorites.includes(b.name);
                    if (aIsFav && !bIsFav) return -1;
                    if (!aIsFav && bIsFav) return 1;
                    return a.name.localeCompare(b.name);
                });
            }, [searchTerm, favorites, allMedications]);

            const isUserAddedMed = selectedMed?.id && userAddedMedsMap[selectedMed.id];

            if(selectedMed){
                return (
                    <div className="bg-slate-900 p-4 md:p-6 rounded-3xl shadow-xl border border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl md:text-2xl font-bold text-white truncate">{selectedMed.name}</h2>
                             <div className="flex items-center gap-2">
                                <button onClick={() => setIsEditing(!isEditing)} className="p-2 text-gray-400 hover:text-white" title={isEditing ? "Ver" : "Editar"}>
                                    {isEditing ? <BookOpen size={24} /> : <FileDown size={24} />}
                                </button>
                                {isUserAddedMed && (
                                    <button onClick={() => handleDeleteUserMed(selectedMed.id)} className="p-2 text-red-500 hover:text-red-400" title="Eliminar medicamento"><Trash size={24} /></button>
                                )}
                                <button onClick={() => setSelectedMed(null)} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                            </div>
                        </div>

                        {isEditing ? (
                                <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-400 mb-1">Nombre del Fármaco</label>
                                        <input type="text" value={editableMed.name} onChange={e => handleEditChange('name', e.target.value)} className="w-full p-2 bg-slate-700 rounded-lg text-gray-200" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-400 mb-1">Nombres Comerciales</label>
                                        <div className="flex flex-wrap gap-2 mb-2">
                                            {editableMed.commercial_names.map((name, idx) => (
                                                <span key={idx} className="bg-slate-600 px-2 py-1 rounded-full text-xs flex items-center">
                                                    {name}
                                                    <button onClick={() => handleRemoveCommercialName(idx)} className="ml-1 text-gray-400 hover:text-white"><X size={12} /></button>
                                                </span>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="text" value={newCommercialName} onChange={e => setNewCommercialName(e.target.value)} placeholder="Añadir nombre..." className="w-full p-2 bg-slate-700 rounded-lg text-gray-200" />
                                            <button onClick={handleAddCommercialName} className="p-2 bg-blue-600 text-white rounded-lg"><PlusCircle size={20} /></button>
                                        </div>
                                    </div>

                                    <hr className="border-slate-700" />

                                    <h3 className="font-bold text-sm text-gray-300 mb-2">Presentaciones y Concentraciones</h3>
                                    {editableMed.concentration && Object.keys(editableMed.concentration).map(key => (
                                        <div key={key} className="flex items-center gap-2 mb-2">
                                            <span className="text-gray-400 w-1/3">{key}:</span>
                                            <input type="text" value={editableMed.concentration[key]} onChange={e => handleEditChange('concentration', { key, value: e.target.value })} className="w-2/3 p-2 bg-slate-700 rounded-lg text-gray-200" />
                                        </div>
                                    ))}

                                    <hr className="border-slate-700" />

                                    <h3 className="font-bold text-sm text-gray-300 mb-2">Dosis por Especie</h3>
                                    {editableMed.doses && Object.keys(editableMed.doses).map(speciesKey => (
                                        <div key={speciesKey} className="bg-slate-700/50 p-3 rounded-lg mb-4">
                                            <h4 className="font-bold text-blue-300 mb-2">{speciesEmojis[speciesKey] || ''} {speciesKey}</h4>
                                            {editableMed.doses[speciesKey].map((dose, doseIndex) => (
                                                 <div key={doseIndex} className="bg-slate-800 p-2 rounded-lg mb-2">
                                                     <div>
                                                         <label className="block text-sm text-gray-400">Propósito:</label>
                                                         <input type="text" value={dose.purpose} onChange={e => handleEditChange('purpose', e.target.value, speciesKey, doseIndex)} className="w-full p-1 bg-slate-700 rounded-lg text-gray-200 text-sm" />
                                                     </div>
                                                     <div className="grid grid-cols-3 gap-2 mt-2 text-sm">
                                                         <div>
                                                             <label className="block text-gray-400">Dosis Rec:</label>
                                                             <input type="number" step="0.1" value={dose.dose_range_rec} onChange={e => handleEditChange('dose_range', { min: dose.dose_range_min, rec: parseFloat(e.target.value), max: dose.dose_range_max }, speciesKey, doseIndex)} className="w-full p-1 bg-slate-700 rounded-lg text-gray-200" />
                                                         </div>
                                                         <div>
                                                             <label className="block text-gray-400">Unidad:</label>
                                                             <input type="text" value={dose.unit} onChange={e => handleEditChange('unit', e.target.value, speciesKey, doseIndex)} className="w-full p-1 bg-slate-700 rounded-lg text-gray-200" />
                                                         </div>
                                                         <div>
                                                             <label className="block text-gray-400">Ruta:</label>
                                                             <input type="text" value={dose.route} onChange={e => handleEditChange('route', e.target.value, speciesKey, doseIndex)} className="w-full p-1 bg-slate-700 rounded-lg text-gray-200" />
                                                         </div>
                                                     </div>
                                                 </div>
                                             ))}
                                             <div className="flex items-center gap-2 mt-2">
                                                 <input type="text" value={newDosePurpose} onChange={e => setNewDosePurpose(e.target.value)} placeholder="Nuevo propósito..." className="w-full p-2 bg-slate-800 rounded-lg" />
                                                 <button onClick={() => handleAddDosePurpose(speciesKey)} className="p-2 bg-blue-600 text-white rounded-lg"><PlusCircle size={20} /></button>
                                             </div>
                                         </div>
                                     ))}

                                     <div className="mt-4">
                                         <h3 className="font-bold text-sm text-gray-300 mb-2">Añadir Nueva Especie</h3>
                                         <div className="flex gap-2">
                                             <select value={newSpecies} onChange={e => setNewSpecies(e.target.value)} className="w-full p-2 bg-slate-700 rounded-lg text-gray-200">
                                                 <option value="">Selecciona una especie...</option>
                                                 {speciesList.filter(s => !Object.keys(editableMed.doses || {}).includes(s)).map(s => <option key={s} value={s}>{speciesEmojis[s] || ''} {s}</option>)}
                                             </select>
                                             <button onClick={handleAddSpecies} className="p-2 bg-green-600 text-white rounded-lg"><PlusCircle size={20} /></button>
                                         </div>
                                     </div>
                                     
                                     {isDirty && (
                                         <button onClick={handleSaveEdits} className="w-full mt-4 flex items-center justify-center gap-2 py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold text-sm">
                                             <Save size={16} /> Guardar Cambios en Vademécum
                                         </button>
                                     )}
                                 </div>
                        ) : (
                            <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                                 <MedicationInfo medData={selectedMed} />
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-white">Vademécum de Consulta Rápida</h2>
                        <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                    </div>
                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Buscar medicamento..." className="w-full px-3 py-2 mb-4 text-gray-200 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <ul className="space-y-2 max-h-[60vh] overflow-y-auto">
                        {filteredMeds.length > 0 ? filteredMeds.map(med => {
                             const isFav = favorites.includes(med.name);
                             const isUserAdded = userAddedMedsMap[med.id];
                             return (
                                 <li key={med.name} onClick={() => setSelectedMed(med)} className={`flex justify-between items-center p-3 rounded-lg cursor-pointer hover:bg-slate-700 ${isFav ? 'bg-slate-800/50 border border-yellow-500/50' : 'bg-slate-800'}`}>
                                     <span>
                                         {med.name}
                                         {isUserAdded && <span className="text-xs text-gray-500 ml-2">(Personal)</span>}
                                     </span>
                                     <button onClick={(e) => { e.stopPropagation(); toggleFavorite(med.name); }} className={`p-1 rounded-full hover:bg-slate-500 ${isFav ? 'text-yellow-400' : 'text-gray-500'}`}>
                                         <Star size={18} fill={isFav ? 'currentColor' : 'none'} />
                                     </button>
                                 </li>
                             )
                        }) : <p className="p-3 text-center text-gray-400">No hay coincidencias.</p>}
                    </ul>
                </div>
            );
        };

        const PhysiologicalConstantsView = ({ onClose, speciesEmojis }) => (
            <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
              <div className="flex justify-between items-center mb-4">
                  <h2 className="text-2xl font-bold text-white">Constantes Fisiológicas</h2>
                  <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
              </div>
              <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm">
                      <thead className="bg-slate-800 text-gray-300">
                          <tr>
                              <th className="p-3">Especie</th>
                              <th className="p-3">Temp °C</th>
                              <th className="p-3">FC (lpm)</th>
                              <th className="p-3">FR (rpm)</th>
                              <th className="p-3">PAS (mmHg)</th>
                          </tr>
                      </thead>
                      <tbody>
                          {Object.entries(physiologicalConstants).map(([species, values]) => (
                              <tr key={species} className="border-b border-slate-700">
                                  <td className="p-3 font-bold">{speciesEmojis[species] || ''} {species}</td>
                                  <td className="p-3">{values['Temp °C']}</td>
                                  <td className="p-3">{values['FC (lpm)']}</td>
                                  <td className="p-3">{values['FR (rpm)']}</td>
                                  <td className="p-3">{values['PAS (mmHg)']}</td>
                              </tr>
                          ))}
                      </tbody>
                  </table>
              </div>
            </div>
        );

        const AnestheticProtocolsView = ({ onClose, speciesEmojis }) => (
            <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-white">Protocolos Anestésicos Sugeridos</h2>
                    <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                </div>
                <div className="space-y-4 max-h-[70vh] overflow-y-auto">
                    {anestheticProtocols.map(proto => (
                        <div key={proto.name} className="bg-slate-800 p-4 rounded-lg">
                            <h3 className="font-bold text-lg text-blue-300">{proto.name}</h3>
                            <p className="text-sm text-gray-400 mb-2">Especie: {speciesEmojis[proto.species] || ''} {proto.species} | ASA: {proto.asa}</p>
                            <p><strong>Premedicación:</strong> {proto.premed}</p>
                            <p><strong>Inducción:</strong> {proto.induction}</p>
                            <p><strong>Mantenimiento:</strong> {proto.maintenance}</p>
                            <p className="text-xs text-gray-300 mt-2 bg-slate-700 p-2 rounded"><em>Nota: {proto.notes}</em></p>
                        </div>
                    ))}
                </div>
            </div>
        );
        
        const AddMedicationAI = ({ onSave, onClose }) => {
            const [step, setStep] = React.useState('input'); // input, loading, confirm
            const [userInput, setUserInput] = React.useState({ name: '', pharma: '', concentration: '', drug: ''});
            const [fetchedData, setFetchedData] = React.useState(null);

            const handleInputChange = (e) => {
                setUserInput({...userInput, [e.target.name]: e.target.value});
            };
            
            const handleSearch = () => {
                // Modificado para usar un modal en lugar de alert()
                const showCustomAlert = (message) => {
                    const alertModal = document.createElement('div');
                    alertModal.className = 'fixed inset-0 bg-slate-900 bg-opacity-75 z-[101] flex items-center justify-center';
                    alertModal.innerHTML = `
                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-white max-w-sm w-full">
                            <h3 class="text-xl font-bold mb-2">Alerta</h3>
                            <p>${message}</p>
                            <button class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="this.parentNode.parentNode.remove()">Aceptar</button>
                        </div>
                    `;
                    document.body.appendChild(alertModal);
                };

                if(!userInput.name || !userInput.concentration || !userInput.drug){
                    showCustomAlert("Por favor, introduce Nombre, Principio Activo y Concentración.");
                    return;
                }
                setStep('loading');
                // --- AI SIMULATION ---
                setTimeout(() => {
                    const newMedData = {
                        name: `${userInput.name} (${userInput.drug})`,
                        commercial_names: [userInput.name],
                        concentration: {},
                        doses: {},
                        functions: "Información no encontrada por IA.",
                        recommendations: "Información no encontrada por IA.",
                        precautions: "Información no encontrada por IA.",
                        contraindications: "Información no encontrada por IA.",
                        interactions: {summary: "", specifics:[]},
                        substitutes: []
                    };
                    const concKey = userInput.concentration.includes('/') ? userInput.concentration.split(' ')[0] : 'default';
                    newMedData.concentration[concKey] = userInput.concentration;
                    setFetchedData(newMedData);
                    setStep('confirm');
                }, 1500);
            };

            const handleSave = () => {
                onSave(fetchedData);
            }

            return (
                <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-white">Añadir Fármaco</h2>
                        <button onClick={onClose} className="p-2 text-gray-400 hover:text-white"><X size={24} /></button>
                    </div>
                    
                    {step === 'input' && (
                        <div className="space-y-4">
                            <p className="text-sm text-gray-300">Introduce los datos del medicamento. La IA buscará la información técnica para rellenar los campos por ti.</p>
                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">Nombre Comercial</label>
                                <input type="text" name="name" value={userInput.name} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">Principio Activo (Fármaco)</label>
                                <input type="text" name="drug" value={userInput.drug} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">Farmacéutica (Opcional)</label>
                                <input type="text" name="pharma" value={userInput.pharma} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-400 mb-1">Concentración (ej. 50 mg/mL, 2%)</label>
                                <input type="text" name="concentration" value={userInput.concentration} onChange={handleInputChange} className="w-full p-2 bg-slate-800 rounded-md" />
                            </div>
                            <button onClick={handleSearch} className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold">Buscar Información</button>
                        </div>
                    )}

                    {step === 'loading' && (
                            <div className="text-center p-8">
                                <p className="text-lg animate-pulse">Buscando en bases de datos...</p>
                            </div>
                    )}

                    {step === 'confirm' && fetchedData && (
                        <div className="space-y-4">
                            <h3 className="text-lg font-bold">Información Encontrada (Editable)</h3>
                            <div className="ai-response-container">
                                <pre>{JSON.stringify(fetchedData, null, 2)}</pre>
                            </div>
                            <div className="flex justify-between gap-4">
                                <button onClick={() => setStep('input')} className="w-full py-2 px-4 bg-gray-500 hover:bg-gray-600 rounded-lg text-white font-bold">Volver</button>
                                <button onClick={handleSave} className="w-full py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold">Aceptar y Guardar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // --- Main App Component ---
        const DosisApp = () => {
        // --- FIREBASE SETUP AND STATE ---
        const [authReady, setAuthReady] = React.useState(false);
        const [userId, setUserId] = React.useState(null);
        const [db, setDb] = React.useState(null);
        const [appId, setAppId] = React.useState(null);

        // State for data fetched from Firestore
        const [userAddedMeds, setUserAddedMeds] = React.useState([]);
        const [favorites, setFavorites] = React.useState([]);
        const [dosisHistory, setDosisHistory] = React.useState([]);
        
        // Use an object to store the Firestore documents keyed by ID
        const userMedsMapRef = React.useRef({});

        React.useEffect(() => {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.getAuth(app);
                setDb(firebase.getFirestore(app));

                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                setAppId(currentAppId);
                
                const unsubscribe = firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await firebase.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await firebase.signInAnonymously(auth);
                        }
                    }
                    setAuthReady(true);
                });

                return () => unsubscribe();
            } else {
                setAuthReady(true);
                setUserId(crypto.randomUUID());
            }
        }, []);

        // Listen for real-time updates to user-added meds
        React.useEffect(() => {
            if (db && userId && appId) {
                const userMedsPath = `/artifacts/${appId}/users/${userId}/meds`;
                const q = firebase.collection(db, userMedsPath);
                
                const unsubscribe = firebase.onSnapshot(q, (snapshot) => {
                    const meds = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data };
                    });
                    userMedsMapRef.current = meds.reduce((acc, med) => {
                        acc[med.id] = med;
                        return acc;
                    }, {});
                    setUserAddedMeds(meds);
                }, (error) => console.error("Error fetching user meds:", error));
                
                return () => unsubscribe();
            }
        }, [db, userId, appId]);

        // Listen for real-time updates to favorites
        React.useEffect(() => {
            if (db && userId && appId) {
                const favoritesPath = `/artifacts/${appId}/users/${userId}/favorites`;
                const docRef = firebase.doc(db, favoritesPath, 'med_favorites');
                
                const unsubscribe = firebase.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setFavorites(data.meds || []);
                    } else {
                        setFavorites([]);
                    }
                }, (error) => console.error("Error fetching favorites:", error));
                
                return () => unsubscribe();
            }
        }, [db, userId, appId]);

        // Listen for real-time updates to dosis history
        React.useEffect(() => {
            if (db && userId && appId) {
                const historyPath = `/artifacts/${appId}/users/${userId}/history`;
                const q = firebase.collection(db, historyPath);
                
                const unsubscribe = firebase.onSnapshot(q, (snapshot) => {
                    const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setDosisHistory(history.sort((a, b) => b.timestamp - a.timestamp).slice(0, 10)); // Keep only the last 10
                }, (error) => console.error("Error fetching history:", error));
                
                return () => unsubscribe();
            }
        }, [db, userId, appId]);

        // --- STATE MANAGEMENT ---
        // Se agregó ageUnit para controlar si la edad es en años o meses.
        const [activeView, setActiveView] = React.useState('calculator');
        const [patient, setPatient] = React.useState({ name: '', species: '', subSpecies: '', weight: '', age: '', ageUnit: 'meses', lifeStage: '' });
        const [medications, setMedications] = React.useState([]);
        const [showHistory, setShowHistory] = React.useState(false);
        const [speciesList, setSpeciesList] = React.useState([]);
        const [notification, setNotification] = React.useState(null);
        const [interactionWarning, setInteractionWarning] = React.useState(null);
        
        const allMedications = React.useMemo(() => {
            const combined = [...initialMedications, ...userAddedMeds.filter(uam => !initialMedications.find(im => im.name === uam.name))];
            return combined.sort((a, b) => a.name.localeCompare(b.name));
        }, [userAddedMeds]);

        const handleUpdateUserMed = async (updatedMed) => {
            if (!db || !userId || !appId) {
                showNotification("No se pudo guardar el medicamento. La base de datos no está lista.", "error");
                return;
            }
            try {
                const userMedsPath = `/artifacts/${appId}/users/${userId}/meds`;
                const medRef = firebase.doc(firebase.collection(db, userMedsPath), updatedMed.id || updatedMed.name);
                await firebase.setDoc(medRef, updatedMed, { merge: true });
                showNotification(`Cambios en "${updatedMed.name.split('(')[0]}" guardados en tu vademécum.`, 'success');
            } catch (e) {
                console.error("Error updating document: ", e);
                showNotification("Error al guardar cambios.", "error");
            }
        };

        const handleAddNewMedication = async (newMed) => {
            if (!db || !userId || !appId) {
                 showNotification("No se pudo guardar el medicamento. La base de datos no está lista.", "error");
                 return;
            }
            try {
                const userMedsPath = `/artifacts/${appId}/users/${userId}/meds`;
                const docRef = firebase.doc(firebase.collection(db, userMedsPath), newMed.name);
                await firebase.setDoc(docRef, newMed, { merge: true });
                showNotification(`${newMed.name.split('(')[0]} ha sido añadido a tu vademécum personal.`, 'success');
                setActiveView('calculator');
            } catch (e) {
                console.error("Error adding document: ", e);
                showNotification("Error al añadir el medicamento.", "error");
            }
        };

        const handleDeleteUserMed = async (medId) => {
            if (!db || !userId || !appId) {
                showNotification("No se pudo eliminar el medicamento. La base de datos no está lista.", "error");
                return;
            }
            try {
                const userMedsPath = `/artifacts/${appId}/users/${userId}/meds`;
                const docRef = firebase.doc(db, userMedsPath, medId);
                await firebase.deleteDoc(docRef);
                showNotification("Medicamento eliminado de tu vademécum personal.", "success");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showNotification("Error al eliminar el medicamento.", "error");
            }
        };
        
        const toggleFavorite = async (medName) => {
            if (!db || !userId || !appId) {
                 showNotification("No se pudo guardar el favorito. La base de datos no está lista.", "error");
                 return;
            }
            const favoritesPath = `/artifacts/${appId}/users/${userId}/favorites`;
            const docRef = firebase.doc(db, favoritesPath, 'med_favorites');
            let newFavorites;
            if (favorites.includes(medName)) {
                newFavorites = favorites.filter(name => name !== medName);
                showNotification(`${medName.split('(')[0].trim()} eliminado de favoritos.`, 'info');
            } else {
                newFavorites = [...favorites, medName];
                showNotification(`${medName.split('(')[0].trim()} añadido a favoritos.`, 'info');
            }
            try {
                await firebase.setDoc(docRef, { meds: newFavorites });
            } catch (e) {
                console.error("Error updating favorites: ", e);
                showNotification("Error al actualizar favoritos.", "error");
            }
        };

        const addMedication = React.useCallback(() => {
            setMedications(prevMeds => [...prevMeds, { id: Date.now(), selectedMed: null, selectedPresentation: '', concentration: '', selectedPurposeIndex: 0, customRecDose: '', selectedDoseType: null, calculatedDoses: null }]);
        }, []);
        
        // Helper to parse unit string and return a multiplier and unit for base conversion
        const parseUnitString = (unitStr) => {
            if (!unitStr) return { multiplier: 1, unit: 'mg' };
            const lowerStr = unitStr.toLowerCase();
            if (lowerStr.includes('mcg')) return { multiplier: 0.001, unit: 'mcg' };
            if (lowerStr.includes('ui')) return { multiplier: 1, unit: 'UI' };
            if (lowerStr.includes('g')) return { multiplier: 1000, unit: 'g' };
            return { multiplier: 1, unit: 'mg' };
        };

        // Centralized calculation function
        const calculateDose = (purpose, weight, concentration, med) => {
            if (!purpose || !weight || !concentration || !purpose.unit || isNaN(parseFloat(concentration)) || parseFloat(concentration) <= 0 || isNaN(parseFloat(weight)) || parseFloat(weight) <= 0) {
                return { min: { value: 'N/A', unit: '' }, rec: { value: 'N/A', unit: '' }, max: { value: 'N/A', unit: '' } };
            }
            const concentrationValStr = med.selectedMed.concentration[med.selectedPresentation] || '';
            const concentrationNum = parseFloat(concentration);
            const weightNum = parseFloat(weight);

            const doseUnitInfo = parseUnitString(purpose.unit);
            const concUnitInfo = parseUnitString(concentrationValStr);
            
            const calc = (doseVal) => {
                if (doseVal === null || typeof doseVal === 'undefined' || isNaN(doseVal)) return { value: 'N/A', unit: '', formula: '' };
                
                let totalDoseAmount;
                let formula = '';
                
                if (purpose.unit.includes('/kg')) {
                    totalDoseAmount = doseVal * weightNum;
                    formula = `(${doseVal} ${purpose.unit.split('/')[0]} * ${weightNum}kg)`;
                } else if (purpose.unit.includes('/perro') || purpose.unit.includes('/gato')) {
                    totalDoseAmount = doseVal;
                    formula = `${doseVal} ${purpose.unit}`;
                } else {
                    return { value: doseVal, unit: purpose.unit.split(" ")[0], formula: 'Dosis directa' };
                }

                let finalUnit = "mL";
                if(concentrationValStr.toLowerCase().includes("tableta")){ finalUnit = "tabletas"; } 
                else if (concentrationValStr.toLowerCase().includes("cápsula")){ finalUnit = "cápsulas"; }
                else if (concentrationValStr.toLowerCase().includes("parche")){ finalUnit = "parche(s)"; }
                
                const doseInBaseUnits = totalDoseAmount * doseUnitInfo.multiplier;
                const concInBaseUnits = concentrationNum * concUnitInfo.multiplier;

                const finalValue = doseInBaseUnits / concInBaseUnits;
                
                return {
                    value: finalValue,
                    unit: finalUnit,
                    formula: `${formula} / ${concentrationNum}${concUnitInfo.unit}`
                };
            };
            return { min: calc(purpose.dose_range_min), rec: calc(purpose.dose_range_rec), max: calc(purpose.dose_range_max) };
        };


        React.useEffect(() => {
            addMedication();
        }, []);
        
        const speciesEmojis = { 'Perros': '🐶', 'Gatos': '🐱', 'Bovinos': '🐮', 'Equinos': '🐴', 'Ovinos': '🐑', 'Caprinos': '🐐', 'Porcinos': '🐷', 'Aves': '🐔', 'Conejos': '🐰', 'Reptiles': '🐍', 'Anfibios': '🐸', 'Exóticos': '🐾', 'Pequeños Mamíferos': '🐹', 'Hurones': '🐾', 'Cobayas': '🐹', 'Ratones': '🐁', 'Ratas': '🐀', 'Hámsters': '🐹', 'Peces': '🐟' };
        
        React.useEffect(() => {
            const rawSpecies = allMedications.flatMap(m => m.doses ? Object.keys(m.doses) : []);
            const unifiedSpecies = new Set(rawSpecies);
            
            const speciesOrder = ['Perros', 'Gatos', 'Equinos', 'Bovinos', 'Porcinos', 'Ovinos', 'Caprinos', 'Conejos', 'Aves', 'Reptiles', 'Anfibios', 'Hurones', 'Cobayas', 'Hámsters', 'Ratones', 'Ratas', 'Peces'];
            const sortedSpecies = speciesOrder.filter(s => unifiedSpecies.has(s));
            setSpeciesList(sortedSpecies);
        }, [allMedications]);

        const exoticSpeciesMap = React.useMemo(() => {
            const map = {};
            allMedications.forEach(med => {
                if (med.doses) {
                    Object.keys(med.doses).forEach(speciesKey => {
                        const categoryMatch = speciesKey.match(/Aves|Reptiles|Conejos|Anfibios|Pequeños Mamíferos/);
                        if (categoryMatch) {
                            const category = categoryMatch[0];
                            if (!map[category]) map[category] = new Set();
                            if (Array.isArray(med.doses[speciesKey])) {
                                med.doses[speciesKey].forEach(speciesDose => {
                                    if (speciesDose.species) {
                                        map[category].add(speciesDose.species);
                                    } else {
                                        if(!map[category].has(speciesKey)) map[category].add(speciesKey);
                                    }
                                });
                            }
                        }
                    });
                }
            });
            Object.keys(map).forEach(category => {
                     map[category] = Array.from(map[category]).sort();
            });
            return map;
        }, [allMedications]);

        React.useEffect(() => {
            setInteractionWarning(null);
        }, [medications]);

        const showNotification = (message, type = 'info') => {
            setNotification({ message, type, id: Date.now() });
            setTimeout(() => setNotification(null), 3000);
        };
        
        const getDoseOptions = (med, species, subSpecies) => {
             if (!med || !med.doses) return [];
             // Prioridad a subespecie si existe una coincidencia directa
             if (subSpecies && med.doses[subSpecies]) {
                 return med.doses[subSpecies];
             }
             // Si no hay subespecie o no hay coincidencia, buscar por especie principal
             if (med.doses[species]) {
                 return med.doses[species];
             }
             return [];
        };

        const getLifeStage = (species, ageInMonths) => {
            const stages = lifeStages[species] || lifeStages['default'];
            const stage = stages.find(s => ageInMonths <= s.maxAgeMonths);
            return stage ? stage.stage : 'Desconocida';
        };

        const handlePatientChange = (e) => {
            const { name, value } = e.target;
            setPatient(prev => {
                const newPatientState = { ...prev, [name]: value };
                let ageInMonths = parseFloat(newPatientState.age);

                if (name === 'ageUnit') {
                    if (prev.age && !isNaN(ageInMonths)) {
                        // Si cambia de años a meses, multiplica por 12
                        if (value === 'meses' && prev.ageUnit === 'años') {
                            ageInMonths *= 12;
                            newPatientState.age = ageInMonths.toFixed(0); // Mostrar como entero para meses
                        }
                        // Si cambia de meses a años, divide por 12
                        else if (value === 'años' && prev.ageUnit === 'meses') {
                            ageInMonths /= 12;
                            newPatientState.age = ageInMonths.toFixed(1); // Mostrar con decimales para años
                        }
                    }
                } else if (name === 'age') {
                    // Si el usuario edita el campo de edad, recalculamos la edad en meses
                    ageInMonths = newPatientState.ageUnit === 'años' ? parseFloat(value) * 12 : parseFloat(value);
                }

                newPatientState.lifeStage = !isNaN(ageInMonths) ? getLifeStage(newPatientState.species, ageInMonths) : '';

                // Si se cambia la especie, resetear sub-especie y edad
                if (name === 'species' && value !== prev.species) {
                    newPatientState.subSpecies = '';
                    newPatientState.age = '';
                    newPatientState.lifeStage = '';
                }

                // Recalcular dosis si el peso cambia
                if(name === 'weight') {
                    setMedications(meds => meds.map(med => {
                        if (med.selectedMed) {
                            const doseOptions = getDoseOptions(med.selectedMed, newPatientState.species, newPatientState.subSpecies);
                            const currentPurposeData = doseOptions[med.selectedPurposeIndex] || {};
                            const purposeDataForCalc = { ...currentPurposeData, dose_range_rec: parseFloat(med.customRecDose) };
                            med.calculatedDoses = calculateDose(purposeDataForCalc, parseFloat(newPatientState.weight), med.concentration, med);
                        }
                        return med;
                    }));
                }

                return newPatientState;
            });
        };


        const handleMedicationUpdate = (index, field, value) => {
            setMedications(prevMedications => {
                const updatedMedications = [...prevMedications];
                let currentMed = { ...updatedMedications[index] };
                let needsRecalc = false;

                if (field === 'select') {
                    currentMed.selectedMed = value;
                    currentMed.selectedPurposeIndex = 0;
                    currentMed.selectedDoseType = null;
                    if(value && value.concentration){
                        const firstPresentation = Object.keys(value.concentration)[0];
                        currentMed.selectedPresentation = firstPresentation;
                        currentMed.concentration = value.concentration[firstPresentation].match(/(\d+\.?\d*)/)?.[0] || '';
                    } else {
                        currentMed.selectedPresentation = '';
                        currentMed.concentration = '';
                    }
                    const doseOptions = getDoseOptions(value, patient.species, patient.subSpecies);
                    const firstDose = doseOptions && doseOptions.length > 0 ? doseOptions[0] : null;
                    currentMed.customRecDose = (firstDose && firstDose.dose_range_rec !== undefined) ? firstDose.dose_range_rec : '';
                    currentMed.selectedDoseType = null;
                    needsRecalc = true;
                } else if (field === 'selectedPresentation') {
                    currentMed.selectedPresentation = value;
                    if (currentMed.selectedMed && currentMed.selectedMed.concentration && currentMed.selectedMed.concentration[value]) {
                        currentMed.concentration = value.concentration[value].match(/(\d+\.?\d*)/)?.[0] || '';
                    }
                    needsRecalc = true;
                } else if (field === 'concentration') {
                    currentMed.concentration = value;
                    needsRecalc = true;
                } else if (field === 'selectedPurposeIndex') {
                    currentMed.selectedPurposeIndex = value;
                    const doseOptions = getDoseOptions(currentMed.selectedMed, patient.species, patient.subSpecies);
                    const newDose = doseOptions && doseOptions[value];
                    currentMed.customRecDose = (newDose && newDose.dose_range_rec !== undefined) ? newDose.dose_range_rec : '';
                    currentMed.selectedDoseType = null;
                    needsRecalc = true;
                } else if (field === 'customRecDose') {
                    currentMed.customRecDose = value;
                    needsRecalc = true;
                } else if (field === 'selectedDoseType') {
                    currentMed.selectedDoseType = value;
                }

                if (needsRecalc && currentMed.selectedMed) {
                    const doseOptions = getDoseOptions(currentMed.selectedMed, patient.species, patient.subSpecies);
                    const currentPurposeData = doseOptions[currentMed.selectedPurposeIndex] || {};
                    const purposeDataForCalc = { ...currentPurposeData, dose_range_rec: parseFloat(currentMed.customRecDose) };
                    currentMed.calculatedDoses = calculateDose(purposeDataForCalc, patient.weight, currentMed.concentration, currentMed);
                }

                updatedMedications[index] = currentMed;
                return updatedMedications;
            });
        };


        const handleReset = React.useCallback(() => {
            setPatient({ name: '', species: '', subSpecies: '', weight: '', age: '', ageUnit: 'meses', lifeStage: '' });
            setMedications([]);
            addMedication();
            showNotification('Formulario reiniciado.', 'info');
        }, [addMedication]);
        
        const handleSaveDosis = async () => {
            if (!db || !userId || !appId) {
                showNotification("No se pudo guardar la dosis. La base de datos no está lista.", "error");
                return;
            }
            if (!patient.name || !patient.species || !patient.weight || medications.every(m => !m.selectedMed)) {
                showNotification("Complete la información del paciente y seleccione al menos un medicamento.", "error");
                return;
            }
            const newEntry = {
                patient: {...patient},
                medications: medications.filter(m => m.selectedMed).map(m => {
                    const doseOptions = getDoseOptions(m.selectedMed, patient.species, patient.subSpecies);
                    const selectedPurpose = doseOptions[m.selectedPurposeIndex];
                    return {
                        name: m.selectedMed.name,
                        concentration: m.concentration,
                        purpose: selectedPurpose ? selectedPurpose.purpose : 'N/A',
                        customRecDose: m.customRecDose,
                        selectedDoseType: m.selectedDoseType,
                        calculatedDoses: m.calculatedDoses
                    }
                }),
                timestamp: firebase.Timestamp.now(),
                userId: userId
            };
            try {
                const historyPath = `/artifacts/${appId}/users/${userId}/history`;
                await firebase.addDoc(firebase.collection(db, historyPath), newEntry);
                showNotification(`Dosis para ${patient.name} guardada en el historial.`, 'success');
            } catch (e) {
                console.error("Error adding history:", e);
                showNotification("Error al guardar la dosis.", "error");
            }
        };
        
        const handleRestoreDosis = (entry) => {
            setPatient(entry.patient);
            setMedications(entry.medications.map(m_hist => {
                const fullMedData = allMedications.find(m => m.name === m_hist.name);
                const doseOptions = getDoseOptions(fullMedData, entry.patient.species, entry.patient.subSpecies);
                const purposeIndex = doseOptions.findIndex(d => d.purpose === m_hist.purpose);

                return {
                    id: Date.now() + Math.random(),
                    selectedMed: fullMedData,
                    concentration: m_hist.concentration,
                    selectedPurposeIndex: purposeIndex !== -1 ? purposeIndex : 0,
                    customRecDose: m_hist.customRecDose,
                    selectedDoseType: m_hist.selectedDoseType || null,
                    calculatedDoses: m_hist.calculatedDoses // Restore calculated data
                }
            }));
            setShowHistory(false);
            showNotification(`Datos de ${entry.patient.name} restaurados.`, 'info');
        };

        const handleGeneratePdf = () => {
            const showCustomAlert = (message) => {
                const alertModal = document.createElement('div');
                alertModal.className = 'fixed inset-0 bg-slate-900 bg-opacity-75 z-[101] flex items-center justify-center';
                alertModal.innerHTML = `
                    <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-white max-w-sm w-full">
                        <h3 class="text-xl font-bold mb-2">Alerta</h3>
                        <p>${message}</p>
                        <button class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" onclick="this.parentNode.parentNode.remove()">Aceptar</button>
                    </div>
                `;
                document.body.appendChild(alertModal);
            };
            
            if (!patient.name || !patient.species || !patient.weight || medications.every(m => !m.selectedMed)) {
                showCustomAlert("Complete todos los campos para generar el PDF.");
                return;
            }
            if (medications.some(m => m.selectedMed && m.selectedDoseType === null)) {
                showCustomAlert("Por favor, seleccione una dosis (Mín, Rec, o Máx) para cada medicamento antes de generar el PDF.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', format: 'letter' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            let cursorY = 20;

            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(23, 37, 84);
            doc.text("Receta Médica Veterinaria", 20, cursorY);
            cursorY += 15;

            // --- Patient Info ---
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(23, 37, 84);
            doc.text("Paciente:", 20, cursorY);
            doc.text("Especie:", 20, cursorY + 10);
            doc.text("Edad:", 20, cursorY + 20);
            doc.text("Peso:", 20, cursorY + 30);

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(45, 55, 72);
            doc.text(patient.name || '', 55, cursorY);
            doc.text(`${patient.species || ''}${patient.subSpecies ? `/${patient.subSpecies}` : ''}`, 55, cursorY + 10);
            doc.text(`${patient.age || 'N/A'} ${patient.ageUnit} (${patient.lifeStage})`, 55, cursorY + 20);
            doc.text(`${patient.weight || ''} kg`, 55, cursorY + 30);
            cursorY += 50;

            // --- Medications List ---
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(32, 114, 204);
            doc.text("Rx", 20, cursorY);
            cursorY += 10;
            
            doc.setDrawColor(32, 114, 204);
            doc.setLineWidth(1);
            doc.line(20, cursorY, pageWidth - 20, cursorY);
            cursorY += 10;

            medications.filter(m => m.selectedMed && m.selectedDoseType).forEach((med, index) => {
                const medData = m.selectedMed;
                const doseOptions = getDoseOptions(medData, patient.species, patient.subSpecies);
                const currentPurposeData = doseOptions[m.selectedPurposeIndex] || {};

                // Use the pre-calculated dose data from the state
                const selectedDoseData = m.calculatedDoses ? m.calculatedDoses[m.selectedDoseType] : { value: 'N/A', unit: '', formula: '' };

                if (cursorY > doc.internal.pageSize.getHeight() - 40) {
                    doc.addPage('landscape');
                    cursorY = 20;
                }
                
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(59, 130, 246);
                doc.text(`${index + 1}. ${medData.name}`, 20, cursorY);
                cursorY += 10;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(45, 55, 72);
                doc.text(`Dosis: ${selectedDoseData.value} ${selectedDoseData.unit}`, 25, cursorY);
                doc.text(`Vía: ${currentPurposeData.route || 'N/A'}`, 110, cursorY);
                doc.text(`Frecuencia: ${currentPurposeData.frequency || 'N/A'}`, 200, cursorY);
                cursorY += 10;
                
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(23, 37, 84);
                doc.text("Indicaciones:", 20, cursorY);
                cursorY += 8;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(71, 85, 105);
                const lineHeight = 5;
                doc.text('________________________________________________________________________________________________________________________________________________', 20, cursorY);
                cursorY += 4 * lineHeight;
            });

            // --- Footer / Signature ---
            const signatureY = doc.internal.pageSize.getHeight() - 30;
            doc.setDrawColor(32, 114, 204);
            doc.setLineWidth(1);
            doc.line(20, signatureY, pageWidth - 20, signatureY);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(45, 55, 72);
            doc.text("Firma del M.V.Z.", 20, signatureY + 5);

            doc.save(`Receta-${patient.name.replace(/\s/g, '_')}.pdf`);
            showNotification("PDF generado exitosamente.", "success");
        };
        
        // --- UI SUB-COMPONENTS ---
        const MedicationSearch = ({ selectedMed, onSelect, species, subSpecies, favorites, toggleFavorite }) => {
            const [searchTerm, setSearchTerm] = React.useState(selectedMed ? selectedMed.name : '');
            const [isFocused, setIsFocused] = React.useState(false);
            const searchRef = React.useRef(null);

            React.useEffect(() => {
                setSearchTerm(selectedMed ? selectedMed.name : '');
            }, [selectedMed]);
            
            const filteredMeds = React.useMemo(() => {
                const allFiltered = allMedications.filter(m => {
                    const hasDoseForSpecies = getDoseOptions(m, species, subSpecies).length > 0;
                    const matchesSearch = searchTerm === '' || m.name.toLowerCase().includes(searchTerm.toLowerCase()) || (m.commercial_names && m.commercial_names.some(name => name.toLowerCase().includes(searchTerm.toLowerCase())));
                    return hasDoseForSpecies && matchesSearch;
                });

                return allFiltered.sort((a, b) => {
                    const aIsFav = favorites.includes(a.name);
                    const bIsFav = favorites.includes(b.name);
                    if (aIsFav && !bIsFav) return -1;
                    if (!aIsFav && bIsFav) return 1;
                    return a.name.localeCompare(b.name);
                });
            }, [searchTerm, species, subSpecies, favorites, allMedications]);


            const handleSelectMed = (medData) => {
                setSearchTerm(medData ? medData.name : '');
                onSelect(medData);
                setIsFocused(false);
            };
            
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (searchRef.current && !searchRef.current.contains(event.target)) setIsFocused(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            return (
                <div className="relative w-full" ref={searchRef}>
                    <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onFocus={() => setIsFocused(true)} placeholder="Buscar medicamento..." className="w-full px-3 py-2 text-gray-200 bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal"/>
                    {searchTerm && (
                        <button onClick={() => handleSelectMed(null)} className="absolute right-10 top-0 h-full px-2 text-gray-500 hover:text-white">
                            <X className="w-4 h-4"/>
                        </button>
                    )}
                    <button onClick={() => setIsFocused(!isFocused)} className="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-white">
                        <ChevronDown className="w-5 h-5"/>
                    </button>
                    {isFocused && (
                        <ul className="absolute z-20 w-full mt-1 bg-slate-700 border border-slate-600 rounded-lg max-h-60 overflow-y-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                            {filteredMeds.length > 0 ? filteredMeds.map(medData => {
                                const isFav = favorites.includes(medData.name);
                                return (
                                <li key={medData.name} onClick={() => handleSelectMed(medData)} className={`flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-slate-600 text-gray-200 ${isFav ? 'bg-slate-800' : ''}`}>
                                    <div>
                                        {medData.name} <span className="text-xs text-gray-400">({(medData.commercial_names || []).join(', ')})</span>
                                    </div>
                                    <button onClick={(e) => { e.stopPropagation(); toggleFavorite(medData.name); }} className={`p-1 rounded-full hover:bg-slate-500 ${isFav ? 'text-yellow-400' : 'text-gray-500'}`}>
                                        <Star size={18} fill={isFav ? 'currentColor' : 'none'} />
                                    </button>
                                </li>
                                );
                            }) : <li className="px-4 py-2 text-gray-400">No hay coincidencias.</li>}
                        </ul>
                    )}
                </div>
            );
        };

        const DosageBlock = ({ med, index, handleUpdateUserMed, patient, favorites, toggleFavorite, allMedications }) => {
            const [localConcentration, setLocalConcentration] = React.useState('');
            const [localCustomRecDose, setLocalCustomRecDose] = React.useState('');
            const [isDirty, setIsDirty] = React.useState(false);
            
            React.useEffect(() => {
                setLocalConcentration(med.concentration);
                setLocalCustomRecDose(med.customRecDose);
            }, [med.concentration, med.customRecDose]);

            const removeMedication = (index) => {
                setMedications(medications.filter((_, i) => i !== index));
            };

            const medData = med.selectedMed;
            const doseOptions = React.useMemo(() => getDoseOptions(medData, patient.species, patient.subSpecies), [medData, patient.species, patient.subSpecies]);
            const currentPurposeData = doseOptions[med.selectedPurposeIndex] || {};
            
            const purposeDataForCalc = { 
                ...currentPurposeData, 
                dose_range_rec: parseFloat(localCustomRecDose) 
            };
            
            const calculatedDoses = calculateDose(purposeDataForCalc, patient.weight, localConcentration, med);


            React.useEffect(() => {
                if (!medData) {
                    setIsDirty(false);
                    return;
                }
                const originalMed = allMedications.find(m => m.name === medData.name);
                if (!originalMed || !med.selectedPresentation) {
                     setIsDirty(false);
                     return;
                }
                
                const originalConcentrationStr = originalMed.concentration[med.selectedPresentation] || '';
                const originalConcentrationNum = originalConcentrationStr.match(/(\d+\.?\d*)/)?.[0] || '';

                const originalDoseOptions = getDoseOptions(originalMed, patient.species, patient.subSpecies);
                const originalPurposeData = originalDoseOptions[med.selectedPurposeIndex] || {};
                
                const concChanged = originalConcentrationNum !== localConcentration;
                const doseChanged = (originalPurposeData.dose_range_rec !== undefined && parseFloat(originalPurposeData.dose_range_rec).toFixed(2) !== parseFloat(localCustomRecDose).toFixed(2));

                setIsDirty(concChanged || doseChanged);

            }, [medData, localConcentration, localCustomRecDose, med.selectedPurposeIndex, med.selectedPresentation, patient.species, patient.subSpecies, allMedications]);

            const handleSaveChanges = () => {
                 const originalMed = allMedications.find(m => m.name === medData.name);
                 if (!originalMed || !med.selectedPresentation) return;

                 // Create a deep copy to avoid direct mutation
                 const medToSave = JSON.parse(JSON.stringify(originalMed));

                 // Update concentration
                 const oldConcStr = medToSave.concentration[med.selectedPresentation];
                 const newConcStr = oldConcStr.replace(/(\d+\.?\d*)/, localConcentration);
                 medToSave.concentration[med.selectedPresentation] = newConcStr;

                 // Update dose
                 const speciesKey = patient.subSpecies || patient.species;
                 if(medToSave.doses && medToSave.doses[speciesKey] && medToSave.doses[speciesKey][med.selectedPurposeIndex]){
                     medToSave.doses[speciesKey][med.selectedPurposeIndex].dose_range_rec = parseFloat(localCustomRecDose);
                 }

                 handleUpdateUserMed(medToSave);
                 setIsDirty(false);
            };

            const DoseDisplay = ({ dose, label, color, type, isSelected, onSelect }) => {
                const selectedClasses = "ring-2 ring-offset-2 ring-offset-slate-800";
                const colorClasses = {
                    yellow: `border-yellow-500/50 ${isSelected ? "ring-yellow-500" : ""}`,
                    green: `border-green-500/50 ${isSelected ? "ring-green-500" : ""}`,
                    red: `border-red-500/50 ${isSelected ? "ring-red-500" : ""}`,
                };

                const doseValue = dose && !isNaN(dose.value) ? parseFloat(dose.value).toFixed(2) : 'N/A';
                if (doseValue === 'N/A') return <div className="p-2 border border-gray-600 rounded-lg flex items-center justify-center cursor-not-allowed"><p className="text-gray-500">N/A</p></div>;
                
                return (
                    <div onClick={onSelect} className={`p-2 border rounded-lg overflow-hidden cursor-pointer relative transition-all ${colorClasses[color]} ${isSelected ? selectedClasses : "hover:scale-105"}`}>
                        {isSelected && (
                            <button onClick={(e) => { e.stopPropagation(); onSelect(null); }} className="absolute top-1 right-1 bg-slate-700 rounded-full p-0.5 text-white hover:bg-slate-600 z-10">
                                <X size={12} />
                            </button>
                        )}
                        <p className={`text-xs text-${color}-400 font-bold`}>{label}</p>
                        <p className={`text-xl text-${color}-400 font-mono font-bold`}>
                            {doseValue} <span className="text-sm">{dose.unit}</span>
                        </p>
                        <p className="text-[10px] text-gray-500 font-mono break-all">{dose.formula}</p>
                    </div>
                );
            };

            const doseDisplaySection = () => {
                if (!med.calculatedDoses) return <div className="p-3 bg-gray-700/50 rounded-lg text-center text-gray-400"><p>Complete los datos para calcular la dosis.</p></div>;

                if (med.selectedDoseType) {
                    const type = med.selectedDoseType;
                    const label = { min: "MÍNIMA", rec: "RECOMENDADA", max: "MÁXIMA" }[type];
                    const color = { min: "yellow", rec: "green", max: "red" }[type];
                    return (
                           <DoseDisplay dose={med.calculatedDoses[type]} label={label} color={color} type={type} isSelected={true} onSelect={() => handleMedicationUpdate(index, 'selectedDoseType', null)} />
                    );
                }

                return (
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 text-center">
                        <DoseDisplay dose={med.calculatedDoses.min} label="MÍNIMA" color="yellow" type="min" isSelected={false} onSelect={() => handleMedicationUpdate(index, 'selectedDoseType', 'min')} />
                        <DoseDisplay dose={med.calculatedDoses.rec} label="RECOMENDADA" color="green" type="rec" isSelected={false} onSelect={() => handleMedicationUpdate(index, 'selectedDoseType', 'rec')} />
                        <DoseDisplay dose={med.calculatedDoses.max} label="MÁXIMA" color="red" type="max" isSelected={false} onSelect={() => handleMedicationUpdate(index, 'selectedDoseType', 'max')} />
                    </div>
                );
            };

            return (
                <div className="bg-slate-800 p-4 rounded-xl shadow-lg mt-4 border border-slate-700">
                    <div className="flex justify-between items-center mb-4 gap-2">
                        <label className="block text-gray-300 text-sm font-bold whitespace-nowrap">Medicamento</label>
                        <div className="flex items-center w-full">
                            <MedicationSearch selectedMed={medData} onSelect={(data) => handleMedicationUpdate(index, 'select', data)} species={patient.species} subSpecies={patient.subSpecies} favorites={favorites} toggleFavorite={toggleFavorite} />
                            {medications.length > 1 && (<button onClick={() => removeMedication(index)} className="ml-2 p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors" title="Eliminar medicamento"><X size={16} /></button>)}
                        </div>
                    </div>
                    
                    {medData && (
                    <div className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            {medData.concentration && Object.keys(medData.concentration).length > 0 && (
                                <div>
                                    <label className="text-gray-300 text-sm font-bold mr-2 mb-1 block whitespace-nowrap">Presentación:</label>
                                    <select value={med.selectedPresentation} onChange={e => handleMedicationUpdate(index, 'selectedPresentation', e.target.value)} className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal">
                                        {Object.keys(medData.concentration).map((pres) => (
                                            <option key={pres} value={pres}>{pres} ({medData.concentration[pres]})</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            <div className="w-full">
                                <label className="text-gray-300 text-sm font-bold mr-2 mb-1 block whitespace-nowrap">Uso del Medicamento:</label>
                                <select value={med.selectedPurposeIndex} onChange={e => handleMedicationUpdate(index, 'selectedPurposeIndex', parseInt(e.target.value))} className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal">
                                    {doseOptions.length > 0 ? doseOptions.map((dose, idx) => (
                                        <option key={`${dose.purpose}-${idx}`} value={idx}>{dose.purpose}</option>
                                    )) : <option value="">No hay dosis para esta especie</option>}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                             <div>
                                 <label className="text-gray-300 text-sm font-bold mr-2 whitespace-nowrap">Concentración:</label>
                                 <input type="text" inputMode="decimal" value={localConcentration} onChange={(e) => setLocalConcentration(e.target.value)} onBlur={(e) => handleMedicationUpdate(index, 'concentration', e.target.value)} className="w-full mt-1 px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal" placeholder="Ej: 50" />
                             </div>
                             <div>
                                 <label className="text-gray-300 text-sm font-bold mr-2 whitespace-nowrap">Dosis:</label>
                                  <input type="text" inputMode="decimal" value={localCustomRecDose} onChange={(e) => setLocalCustomRecDose(e.target.value)} onBlur={(e) => handleMedicationUpdate(index, 'customRecDose', e.target.value)} className="w-full mt-1 px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal" />
                                  {currentPurposeData.dose_range_min !== undefined && (
                                      <p className="text-xs text-gray-400 mt-1">
                                          Rango Sugerido: {currentPurposeData.dose_range_min} - {currentPurposeData.dose_range_max} {currentPurposeData.unit}
                                     </p>
                                  )}
                             </div>
                        </div>
                        
                        {isDirty && (
                            <button onClick={handleSaveChanges} className="w-full flex items-center justify-center gap-2 py-2 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold text-sm">
                                <Save size={16} /> Guardar Cambios en Vademécum
                            </button>
                        )}

                        <div className="my-4">
                             <h3 className="text-md font-bold text-gray-300 mb-2">Dosis Calculada (Selecciona una)</h3>
                             {doseDisplaySection()}
                             {med.calculatedDoses && (
                                 <div className="text-center mt-2 text-sm text-gray-400">
                                     <p>Vía: <span className="font-bold text-gray-200">{currentPurposeData.route || 'N/A'}</span></p>
                                     <p>Frecuencia: <span className="font-bold text-gray-200">{currentPurposeData.frequency || 'N/A'}</span></p>
                                 </div>
                             )}
                        </div>
                        
                        <MedicationInfo medData={medData} />
                    </div>
                    )}
                </div>
            );
        };
        
        // --- RENDER LOGIC ---
        const renderContent = () => {
            const isExoticCategory = ['Aves', 'Reptiles', 'Conejos', 'Anfibios', 'Pequeños Mamíferos'].includes(patient.species);
            
            switch (activeView) {
                case 'emergency': return <EmergencyMode onExit={() => setActiveView('calculator')} />;
                case 'tools': return <ToolsMenu onSelect={(tool) => setActiveView(tool)} />;
                case 'fluid': return <FluidTherapyCalculator onClose={() => setActiveView('calculator')} patient={patient} allMedications={allMedications}/>;
                case 'bsa': return <BSACalculator onClose={() => setActiveView('calculator')} />;
                case 'cri': return <CRICalculator onClose={() => setActiveView('calculator')} />;
                case 'dilution': return <DilutionCalculator onClose={() => setActiveView('calculator')} allMedications={allMedications}/>;
                case 'vademecum': return <VademecumView allMedications={allMedications} favorites={favorites} toggleFavorite={toggleFavorite} onClose={() => setActiveView('calculator')} handleUpdateUserMed={handleUpdateUserMed} handleDeleteUserMed={handleDeleteUserMed} speciesList={speciesList} exoticSpeciesMap={exoticSpeciesMap} speciesEmojis={speciesEmojis} userAddedMedsMap={userMedsMapRef.current} />;
                case 'protocols': return <AnestheticProtocolsView onClose={() => setActiveView('calculator')} speciesEmojis={speciesEmojis} />;
                case 'constants': return <PhysiologicalConstantsView onClose={() => setActiveView('calculator')} speciesEmojis={speciesEmojis} />;
                case 'addMed': return <AddMedicationAI onSave={handleAddNewMedication} onClose={() => setActiveView('calculator')} />;
                case 'calculator':
                default:
                    return (
                        <div className="bg-slate-900 p-6 rounded-3xl shadow-xl border border-gray-700">
                             <h2 className="text-xl font-bold mb-4 text-white">Información del Paciente</h2>
                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                 <div>
                                     <label htmlFor="patientName" className="block text-sm font-bold text-gray-400 mb-1">Nombre</label>
                                     <input id="patientName" type="text" name="name" value={patient.name} onChange={handlePatientChange} className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal" />
                                 </div>
                                 <div>
                                     <label htmlFor="patientSpecies" className="block text-sm font-bold text-gray-400 mb-1">Especie</label>
                                     <select id="patientSpecies" name="species" value={patient.species} onChange={handlePatientChange} className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal">
                                         <option value="">Selecciona</option>
                                         {speciesList.map(species => (<option key={species} value={species}>{speciesEmojis[species] || ''} {species}</option>))}
                                     </select>
                                 </div>
                                 {isExoticCategory && (
                                     <div className="col-span-1 sm:col-span-2">
                                         <label htmlFor="patientSubSpecies" className="block text-sm font-bold text-gray-400 mb-1">{patient.species}</label>
                                         <select id="patientSubSpecies" name="subSpecies" value={patient.subSpecies} onChange={handlePatientChange} className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal">
                                             <option value="">Selecciona específico</option>
                                             {exoticSpeciesMap[patient.species] && exoticSpeciesMap[patient.species].map(subSpecies => (
                                                 <option key={subSpecies} value={subSpecies}>{subSpecies}</option>
                                             ))}
                                         </select>
                                     </div>
                                 )}
                             </div>
                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                 <div>
                                     <label htmlFor="patientWeight" className="block text-sm font-bold text-gray-400 mb-1">Peso (kg)</label>
                                     <input id="patientWeight" type="number" name="weight" value={patient.weight} onChange={handlePatientChange} min="0" step="0.1" className="w-full px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal" placeholder="Ej: 10.5"/>
                                 </div>
                                 <div className="col-span-1">
                                     <label htmlFor="patientAge" className="block text-sm font-bold text-gray-400 mb-1">Edad</label>
                                     <div className="flex items-center gap-2">
                                         <input id="patientAge" type="number" name="age" value={patient.age} onChange={handlePatientChange} min="0" step="1" className="w-full text-xl px-4 py-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-normal" placeholder="Ej: 6"/>
                                         <select name="ageUnit" value={patient.ageUnit} onChange={handlePatientChange} className="p-2 bg-slate-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                                             <option value="meses">meses</option>
                                             <option value="años">años</option>
                                         </select>
                                         {patient.lifeStage && (
                                             <p className="text-xs text-gray-400 whitespace-nowrap">({patient.lifeStage})</p>
                                         )}
                                     </div>
                                 </div>
                             </div>
                             
                             {interactionWarning && (
                                    <div className="flex items-start p-3 my-4 bg-purple-900/50 border-l-4 border-purple-500 rounded-md text-purple-300">
                                        <AlertTriangle className="mr-3 flex-shrink-0 mt-1" />
                                        <div><strong className="font-bold">Posible Interacción:</strong> {interactionWarning}</div>
                                    </div>
                              )}

                             {(patient.species && patient.weight && (!isExoticCategory || patient.subSpecies)) ? medications.map((med, index) => (<DosageBlock key={med.id} med={med} index={index} handleUpdateUserMed={handleUpdateUserMed} patient={patient} favorites={favorites} toggleFavorite={toggleFavorite} allMedications={allMedications}/>)) : (
                                 <div className="text-center py-8 text-gray-500">
                                     <p>Por favor, completa la información del paciente para empezar.</p>
                                 </div>
                             )}
                             
                             {(patient.species && patient.weight && (!isExoticCategory || patient.subSpecies)) && (
                                     <div className="flex flex-wrap items-center justify-between mt-6 gap-3">
                                         <button onClick={addMedication} className="flex items-center space-x-2 px-4 py-2 text-white bg-blue-600 rounded-full hover:bg-blue-700 transition-colors shadow-lg"><PlusCircle size={20} /><span>Añadir Medicamento</span></button>
                                         <div className="flex items-center gap-3">
                                             <button onClick={handleSaveDosis} className="flex items-center space-x-2 px-4 py-2 text-white bg-green-600 rounded-full hover:bg-green-700 transition-colors shadow-lg"><ClipboardList size={20} /><span>Guardar Dosis</span></button>
                                             <button onClick={handleGeneratePdf} className="flex items-center space-x-2 px-4 py-2 text-white bg-red-600 rounded-full hover:bg-red-700 transition-colors shadow-lg"><FileDown size={20} /><span>Generar PDF</span></button>
                                         </div>
                                     </div>
                             )}
                        </div>
                    );
            }
        }


        return (
            <div className="min-h-screen bg-slate-950 p-4 font-sans text-gray-200">
                 <div className="max-w-4xl mx-auto">
                     {notification && (<div className={`fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 animate-fade-in-out ${notification.type === 'success' ? 'bg-green-600' : notification.type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`}>{notification.message}</div>)}

                    <div className="text-center p-4">
                          <h1 className="text-3xl sm:text-4xl font-extrabold text-white">Dosis Perronas</h1>
                          <p className="text-sm text-gray-400 font-normal">by: Arturo Alvarado</p>
                    </div>
                    
                      <div className="flex justify-center items-center flex-wrap gap-2 p-2 mb-6 bg-slate-900 rounded-xl">
                           <button onClick={() => setActiveView(activeView === 'tools' ? 'calculator' : 'tools')} className="p-2 text-gray-400 hover:text-white transition-colors" title="Herramientas"><Menu size={24} /></button>
                           <button onClick={() => setActiveView('emergency')} className="p-2 text-red-500 hover:text-red-400 transition-colors" title="Modo Emergencia"><Siren size={24} /></button>
                           <button onClick={handleReset} className="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Reiniciar"><RotateCw size={24} /></button>
                           <button onClick={() => setShowHistory(true)} className="p-2 text-gray-400 hover:text-white transition-colors" title="Historial"><MoreVertical size={24} /></button>
                       </div>
                    
                     {renderContent()}

                     {showHistory && <HistoryModal history={dosisHistory} onClose={() => setShowHistory(false)} onRestore={handleRestoreDosis} />}
                 </div>
            </div>
        );
        };
        
        ReactDOM.render(<DosisApp />, document.getElementById('root'));
    </script>
</body>
</html>